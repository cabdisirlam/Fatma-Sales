<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f6fa; padding: 20px; }
    .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; }
    .card { border: none; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .table th { font-weight: 600; color: #555; }
    .user-avatar { width: 35px; height: 35px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
    .status-active { color: #198754; font-weight: 600; }
    .status-inactive { color: #dc3545; font-weight: 600; }

    /* Mobile Responsive Styles */
    @media (max-width: 767.98px) {
      body { padding: 10px; }

      .header-section {
        padding: 15px;
        border-radius: 10px;
      }

      .header-section h2 { font-size: 1.5rem; }
      .header-section p { font-size: 0.9rem; }

      .card {
        border-radius: 10px;
      }

      .card-header {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1rem;
      }

      .card-header .btn {
        width: 100%;
      }

      /* Make table scroll horizontally on mobile */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table {
        font-size: 0.85rem;
        min-width: 600px;
      }

      .table th, .table td {
        padding: 0.5rem 0.3rem;
      }

      .user-avatar {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
        margin-right: 5px;
      }

      .btn-sm {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
      }

      /* Make modals full width on mobile */
      .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
      }

      .modal-body {
        padding: 1rem;
      }

      .modal-header {
        padding: 1rem;
      }

      .modal-header .modal-title {
        font-size: 1.1rem;
      }

      /* Stack form fields on mobile */
      .modal-body .row > [class*="col-"] {
        margin-bottom: 0.75rem;
      }
    }

    /* Tablet Responsive Styles */
    @media (min-width: 768px) and (max-width: 991.98px) {
      body { padding: 15px; }
      .header-section { padding: 20px; }
    }

    /* Mobile performance tweaks */
    @media (max-width: 767.98px) {
      .card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section,
      .btn,
      .btn-action,
      .table-responsive,
      .menu-item a,
      .toggle-btn,
      .sidebar,
      .top-bar {
        transition: none !important;
      }

      .card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
      }

      .modal-content {
        font-size: 11px;
      }

      .modal-title,
      .modal-body,
      .modal-body .form-label,
      .modal-body .form-control,
      .modal-body .form-select,
      .modal-body .btn,
      .modal-footer .btn {
        font-size: 11px;
      }

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 0.5rem 0.75rem;
      }

      .modal-body .form-control,
      .modal-body .form-select {
        padding: 0.35rem 0.5rem;
      }

      .modal-footer {
        gap: 0.4rem;
      }
    }
.card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
      }

      .modal-title {
        font-size: 1rem;
      }

      .modal-body {
        font-size: 0.875rem;
      }

      .modal-body .form-label {
        font-size: 0.8125rem;
      }

      .modal-body .form-control,
      .modal-body .form-select {
        font-size: 0.875rem;
        padding: 0.5rem 0.65rem;
      }

      .modal-footer .btn {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
      }
    }
.card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
      }
    }
.header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .badge,
      .table-responsive,
      .modal-content {
        box-shadow: none !important;
      }

      .header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .modal-content {
        border-radius: 8px !important;
      }

      .btn,
      .btn-action {
        box-shadow: none !important;
      }
    }
.header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .btn,
      .btn-action,
      .badge,
      .table-responsive,
      .modal-content {
        box-shadow: none !important;
      }

      .header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .btn,
      .btn-action,
      .modal-content {
        border-radius: 8px !important;
      }
    }
</style>
</head>
<body>
  <div class="header-section">
    <h2><i class="bi bi-people"></i> User Management</h2>
    <p class="mb-0">Manage system users, assign roles, and control access.</p>
  </div>

  <div id="alertContainer"></div>

  <div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <h5 class="mb-0 text-primary"><i class="bi bi-list-ul"></i> System Users</h5>
      <button class="btn btn-primary" onclick="showAddUserModal()">
        <i class="bi bi-person-plus"></i> Add New User
      </button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addUserForm" onsubmit="handleAddUser(event)">
            <div class="mb-3">
              <label class="form-label">Username *</label>
              <input type="text" class="form-control" id="newUsername" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email *</label>
              <input type="email" class="form-control" id="newEmail" required>
            </div>
            <div class="row">
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">PIN (4 Digits) *</label>
                <input type="password" class="form-control" id="newPin" pattern="[0-9]{4}" maxlength="4" required>
              </div>
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Role *</label>
                <select class="form-select" id="newRole" required>
                  <option value="">Select Role</option>
                  <option value="Admin">Admin</option>
                  <option value="Manager">Manager</option>
                  <option value="Sales">Sales</option>
                  <option value="Cashier">Cashier</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="newStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="btnSaveUser">Save User</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm" onsubmit="handleEditUser(event)">
            <input type="hidden" id="editUserId">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" id="editUsername" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            <div class="row">
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Role</label>
                <select class="form-select" id="editRole" required>
                  <option value="Admin">Admin</option>
                  <option value="Manager">Manager</option>
                  <option value="Sales">Sales</option>
                  <option value="Cashier">Cashier</option>
                </select>
              </div>
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="editStatus">
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
            </div>
            <div class="alert alert-light border small">
              <i class="bi bi-info-circle"></i> To deactivate a user, set Status to <strong>Inactive</strong>.
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-warning" id="btnUpdateUser">Update User</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', loadUsers);

    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      setTimeout(() => container.innerHTML = '', 3000);
    }

    function loadUsers() {
      google.script.run
        .withSuccessHandler(displayUsers)
        .withFailureHandler(err => showAlert('Error loading users: ' + err.message, 'danger'))
        .getUsers();
    }

    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No users found.</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(u => `
        <tr class="${u.Status === 'Inactive' ? 'table-secondary' : ''}">
          <td>
            <div class="d-flex align-items-center">
              <div class="user-avatar">${u.Username.charAt(0).toUpperCase()}</div>
              <div>
                <div class="fw-bold">${u.Username}</div>
                <small class="text-muted">${u.User_ID}</small>
              </div>
            </div>
          </td>
          <td>${u.Email}</td>
          <td><span class="badge bg-${getRoleColor(u.Role)}">${u.Role}</span></td>
          <td>
            <span class="${u.Status === 'Active' ? 'status-active' : 'status-inactive'}">
              <i class="bi bi-circle-fill" style="font-size: 8px;"></i> ${u.Status}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick='openEditModal(${JSON.stringify(u)})' title="Edit Role/Status">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.User_ID}', '${u.Username}')" title="Delete Permanently">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function getRoleColor(role) {
      if (role === 'Admin') return 'danger';
      if (role === 'Manager') return 'primary';
      if (role === 'Sales') return 'info';
      return 'secondary';
    }

    // --- Add User ---
    function showAddUserModal() {
      document.getElementById('addUserForm').reset();
      new bootstrap.Modal(document.getElementById('addUserModal')).show();
    }

    function handleAddUser(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSaveUser');
      btn.disabled = true; btn.innerText = 'Saving...';

      const userData = {
        Username: document.getElementById('newUsername').value,
        Email: document.getElementById('newEmail').value,
        PIN: document.getElementById('newPin').value,
        Role: document.getElementById('newRole').value,
        Status: document.getElementById('newStatus').value
      };

      google.script.run
        .withSuccessHandler(res => {
          btn.disabled = false; btn.innerText = 'Save User';
          if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            showAlert('User added successfully');
            loadUsers();
          } else {
            showAlert(res.message, 'danger');
          }
        })
        .withFailureHandler(err => {
          btn.disabled = false; btn.innerText = 'Save User';
          showAlert(err.message, 'danger');
        })
        .addUser(userData);
    }

    // --- Edit User ---
    function openEditModal(user) {
      document.getElementById('editUserId').value = user.User_ID;
      document.getElementById('editUsername').value = user.Username;
      document.getElementById('editEmail').value = user.Email;
      document.getElementById('editRole').value = user.Role;
      document.getElementById('editStatus').value = user.Status;
      new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    function handleEditUser(e) {
      e.preventDefault();
      const btn = document.getElementById('btnUpdateUser');
      btn.disabled = true; btn.innerText = 'Updating...';

      const userData = {
        User_ID: document.getElementById('editUserId').value,
        Username: document.getElementById('editUsername').value,
        Email: document.getElementById('editEmail').value,
        Role: document.getElementById('editRole').value,
        Status: document.getElementById('editStatus').value
      };

      google.script.run
        .withSuccessHandler(res => {
          btn.disabled = false; btn.innerText = 'Update User';
          if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            showAlert('User updated successfully');
            loadUsers();
          } else {
            showAlert(res.message, 'danger');
          }
        })
        .withFailureHandler(err => {
          btn.disabled = false; btn.innerText = 'Update User';
          showAlert(err.message, 'danger');
        })
        .updateUser(userData);
    }

    // --- Delete User ---
    function deleteUser(userId, username) {
      if (confirm(`Are you sure you want to permanently delete user "${username}"?\n\nTo just remove access, consider editing and setting Status to 'Inactive' instead.`)) {
        google.script.run
          .withSuccessHandler(res => {
            if (res.success) {
              showAlert('User deleted');
              loadUsers();
            } else {
              showAlert(res.message, 'danger');
            }
          })
          .deleteUser(userId);
      }
    }
  </script>
</body>
</html>







