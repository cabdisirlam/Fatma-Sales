<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f6fa; padding: 20px; }
    .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    /* Quick Action Buttons */
    .action-btn-group { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
    .btn-action { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 600; color: white; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: transform 0.2s; min-width: 150px; }
    .btn-action:hover { transform: translateY(-3px); color: white; opacity: 0.95; }
    .btn-action i { font-size: 24px; }
    
    .btn-income { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-expense { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .btn-bank { background: linear-gradient(135deg, #3498db, #2980b9); }
    .btn-account { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

    /* Stats */
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; height: 100%; }
    .stat-value { font-size: 22px; font-weight: 700; margin: 10px 0; color: #2c3e50; }
    .stat-label { color: #7f8c8d; font-size: 12px; text-transform: uppercase; font-weight: 600; }
    .text-success-custom { color: #27ae60 !important; }
    .text-danger-custom { color: #e74c3c !important; }

    /* Table */
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .card-header { background: white; border-bottom: 1px solid #eee; padding: 15px 20px; font-weight: 700; color: #2c3e50; }
    .table th { font-weight: 600; color: #555; font-size: 13px; }
    .table td { font-size: 14px; vertical-align: middle; }
    
    /* Loading */
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; display: none; }

    /* Mobile Responsive Styles */
    @media (max-width: 767.98px) {
      body { padding: 10px; }
      .header-section { padding: 15px; border-radius: 10px; }
      .header-section h2 { font-size: 1.5rem; }
      .header-section p { font-size: 0.9rem; }

      .action-btn-group { flex-direction: column; gap: 10px; }
      .btn-action { min-width: 100%; padding: 12px; }
      .btn-action i { font-size: 20px; }

      .stat-card { padding: 15px; margin-bottom: 10px; }
      .stat-value { font-size: 1.5rem; }
      .stat-label { font-size: 0.75rem; }

      .card { border-radius: 10px; }
      .card-header { padding: 12px 15px; flex-wrap: wrap; gap: 0.5rem; }
      .card-header .btn { width: 100%; margin-top: 0.5rem; }

      .table { font-size: 0.8rem; min-width: 600px; }
      .table th, .table td { padding: 0.5rem 0.3rem; white-space: nowrap; }

      .modal-dialog { margin: 0.5rem; max-width: calc(100% - 1rem); }
      .modal-body { padding: 1rem; }
    }

    @media (min-width: 768px) and (max-width: 991.98px) {
      body { padding: 15px; }
      .action-btn-group { gap: 10px; }
      .btn-action { flex: 1 1 calc(50% - 10px); min-width: 150px; }
    }
  </style>
</head>
<body>

  <div class="header-section">
    <h2 style="margin:0; font-weight:700;"><i class="bi bi-wallet2"></i> Financial Management</h2>
    <p style="margin:5px 0 0 0; opacity: 0.9;">Manage Cash, M-Pesa, Bank Accounts & Expenses</p>
  </div>

  <div class="action-btn-group">
    <button class="btn-action btn-income" onclick="openModal('modalReceivePayment')">
      <i class="bi bi-box-arrow-in-down-left"></i>
      Receive From Client
    </button>
    <button class="btn-action btn-expense" onclick="openModal('modalRecordExpense')">
      <i class="bi bi-box-arrow-up-right"></i>
      Pay Expense
    </button>
    <button class="btn-action btn-bank" onclick="openModal('modalBankTxn')">
      <i class="bi bi-bank"></i>
      Bank / Cash Txn
    </button>
    <button class="btn-action btn-account" onclick="openModal('modalAddAccount')">
      <i class="bi bi-plus-circle-dotted"></i>
      Add New Account
    </button>
  </div>

  <div class="row mb-4">
    <div class="col-12 col-sm-6 col-md-3 mb-3 mb-md-0">
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value text-success-custom" id="totalRevenue">...</div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3 mb-md-0">
      <div class="stat-card">
        <div class="stat-label">Total Expenses</div>
        <div class="stat-value text-danger-custom" id="totalExpenses">...</div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3 mb-3 mb-md-0">
      <div class="stat-card">
        <div class="stat-label">Net Profit</div>
        <div class="stat-value" id="netProfit">...</div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
      <div class="stat-card">
        <div class="stat-label">System Balance</div>
        <div class="stat-value text-primary" id="systemBalance">...</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><i class="bi bi-piggy-bank"></i> Account Balances</div>
    <div class="card-body">
      <div class="row" id="accountBalancesContainer">
        <div class="col-12 text-center py-3"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="bi bi-list-ul"></i> Recent Transactions</span>
      <button class="btn btn-sm btn-outline-primary" onclick="loadFinancialData()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>ID</th>
              <th>Type</th>
              <th>Account</th>
              <th>Description</th>
              <th class="text-end">Credit (In)</th>
              <th class="text-end">Debit (Out)</th>
            </tr>
          </thead>
          <tbody id="txnTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalReceivePayment" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-cash"></i> Receive from Client</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formReceivePayment">
            <div class="mb-3">
              <label class="form-label">Customer</label>
              <select class="form-select" name="customer" id="inputRecvCustomer" required>
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount (Ksh)</label>
              <input type="number" class="form-control" name="amount" required step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Deposit To (Account)</label>
              <select class="form-select" name="account" id="inputRecvAccount" required>
                 </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Reference / Notes</label>
              <input type="text" class="form-control" name="ref" placeholder="Receipt No / M-Pesa Code">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="submitTxn('client_payment')">Confirm Receipt</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalRecordExpense" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="bi bi-receipt"></i> Record Expense</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formRecordExpense">
            <div class="mb-3">
              <label class="form-label">Expense Category</label>
              <select class="form-select" name="category" id="inputExpCategory" required>
                 </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount (Ksh)</label>
              <input type="number" class="form-control" name="amount" required step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Pay From (Account)</label>
              <select class="form-select" name="account" id="inputExpAccount" required>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Description / Notes</label>
              <textarea class="form-control" name="notes" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="submitTxn('expense')">Pay Expense</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalBankTxn" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-bank"></i> Bank / Cash Transaction</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formBankTxn">
            <div class="mb-3">
              <label class="form-label">Transaction Type</label>
              <select class="form-select" name="subType" id="inputBankType">
                <option value="bank_deposit">Deposit (Money In)</option>
                <option value="bank_withdrawal">Withdrawal (Money Out)</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Account</label>
              <select class="form-select" name="account" id="inputBankAccount" required>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount (Ksh)</label>
              <input type="number" class="form-control" name="amount" required step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Description / Reference</label>
              <input type="text" class="form-control" name="notes">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitTxn('bank_txn')">Process</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalAddAccount" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-purple text-white" style="background-color: #8e44ad;">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Account</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formAddAccount">
            <div class="mb-3">
              <label class="form-label">Account Name</label>
              <input type="text" class="form-control" name="accountName" placeholder="e.g., KCB Bank, Petty Cash" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Opening Balance (Ksh)</label>
              <input type="number" class="form-control" name="openingBal" value="0" step="0.01">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" style="background-color: #8e44ad; border-color: #8e44ad;" onclick="submitTxn('add_account')">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUser = sessionStorage.getItem('userName') || 'SYSTEM';
    let allAccounts = []; // Store accounts locally

    document.addEventListener('DOMContentLoaded', function() {
      loadFinancialData();
      loadDropdownData();
    });

    function openModal(id) {
      new bootstrap.Modal(document.getElementById(id)).show();
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // --- DATA LOADING ---
    function loadFinancialData() {
      // 1. Load Summary
      google.script.run.withSuccessHandler(renderStats).getFinancialSummary();
      // 2. Load Transactions
      google.script.run.withSuccessHandler(renderTxns).getFinancialTransactions({limit: 20});
    }

    function loadDropdownData() {
      google.script.run.withSuccessHandler(data => {
        allAccounts = data.accounts; // Store for refresher
        populateSelect('inputRecvAccount', data.accounts);
        populateSelect('inputExpAccount', data.accounts);
        populateSelect('inputBankAccount', data.accounts);
        
        populateSelect('inputExpCategory', data.categories);
        
        // Customers with Balance info
        const custSelect = document.getElementById('inputRecvCustomer');
        custSelect.innerHTML = '<option value="">Select Customer...</option>';
        data.customers.forEach(c => {
          const balText = c.balance < 0 ? ` (Owes: ${Math.abs(c.balance)})` : '';
          custSelect.add(new Option(c.name + balText, c.id));
        });

      }).getFinancialUiData();
    }

    function populateSelect(id, items) {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      items.forEach(i => sel.add(new Option(i, i)));
    }

    // --- RENDERING ---
    function renderStats(data) {
      document.getElementById('totalRevenue').textContent = formatMoney(data.totalRevenue);
      document.getElementById('totalExpenses').textContent = formatMoney(data.totalExpenses);
      document.getElementById('netProfit').textContent = formatMoney(data.netProfit);
      document.getElementById('systemBalance').textContent = formatMoney(data.currentBalance);

      // Account Balances
      const accContainer = document.getElementById('accountBalancesContainer');
      accContainer.innerHTML = '';
      if(data.accountBalances) {
        for(const [acc, bal] of Object.entries(data.accountBalances)) {
           const col = document.createElement('div');
           col.className = 'col-md-3 mb-2';
           col.innerHTML = `
             <div class="p-3 border rounded bg-light text-center">
                <small class="text-muted fw-bold text-uppercase">${acc}</small>
                <div class="fs-5 fw-bold text-primary">${formatMoney(bal)}</div>
             </div>
           `;
           accContainer.appendChild(col);
        }
      }
    }

    function renderTxns(data) {
      const tbody = document.getElementById('txnTableBody');
      tbody.innerHTML = '';
      if(!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No recent transactions</td></tr>';
        return;
      }
      
      data.slice(0,15).forEach(t => { // Show top 15
        const date = new Date(t.DateTime).toLocaleDateString();
        const credit = parseFloat(t.Credit) || 0;
        const debit = parseFloat(t.Debit) || 0;
        const id = t.Transaction_ID || '';
        
        const row = `<tr>
          <td>${date}</td>
          <td><small>${id}</small></td>
          <td><span class="badge bg-secondary">${t.Type}</span></td>
          <td>${t.Account}</td>
          <td>${t.Description}</td>
          <td class="text-end text-success">${credit > 0 ? formatMoney(credit) : '-'}</td>
          <td class="text-end text-danger">${debit > 0 ? formatMoney(debit) : '-'}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // --- SUBMISSION ---
    function submitTxn(type) {
      let data = { txnType: type, User: currentUser };
      let formId = '';
      let modalId = '';

      if (type === 'client_payment') {
        formId = 'formReceivePayment';
        modalId = 'modalReceivePayment';
        const form = document.getElementById(formId);
        
        const custId = form.customer.value;
        if(!custId) return alert("Select Customer");
        // Find customer Name from dropdown text
        const custName = form.customer.options[form.customer.selectedIndex].text.split(' (')[0];
        
        data.customerId = custId;
        data.customerName = custName;
        data.amount = form.amount.value;
        data.account = form.account.value;
        data.notes = form.ref.value;

      } else if (type === 'expense') {
        formId = 'formRecordExpense';
        modalId = 'modalRecordExpense';
        const form = document.getElementById(formId);
        
        data.category = form.category.value;
        data.amount = form.amount.value;
        data.account = form.account.value;
        data.notes = form.notes.value;

      } else if (type === 'bank_txn') {
        formId = 'formBankTxn';
        modalId = 'modalBankTxn';
        const form = document.getElementById(formId);
        
        data.txnType = form.subType.value; // bank_deposit or bank_withdrawal
        data.account = form.account.value;
        data.amount = form.amount.value;
        data.notes = form.notes.value;

      } else if (type === 'add_account') {
        formId = 'formAddAccount';
        modalId = 'modalAddAccount';
        const form = document.getElementById(formId);
        
        data.account = form.accountName.value.trim();
        data.openingBal = form.openingBal.value;
        if(!data.account) return alert("Enter Account Name");
      }

      if (!data.amount && type !== 'add_account') return alert("Enter Amount");

      showLoading(true);
      
      google.script.run
        .withSuccessHandler(res => {
           showLoading(false);
           if(res.success) {
             bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
             document.getElementById(formId).reset();
             alert(res.message);
             loadFinancialData(); // Refresh UI
             if(type === 'add_account') loadDropdownData(); // Reload dropdowns
           } else {
             alert("Error: " + res.message);
           }
        })
        .withFailureHandler(e => {
           showLoading(false);
           alert("System Error: " + e.message);
        })
        .handleFinancialTransaction(data);
    }

    function formatMoney(amount) {
      return 'Ksh ' + parseFloat(amount || 0).toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
  </script>
</body>
</html>
