<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers Management</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      padding: 20px;
    }

    .header-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .header-section h2 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }

    .header-section p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px 15px 0 0 !important;
      padding: 20px;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .table {
      margin: 0;
    }

    .table thead {
      background: #f8f9fa;
    }

    .table th {
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      color: #2c3e50;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 500;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin: 10px 0;
    }

    .stat-label {
      color: #7f8c8d;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .balance-negative {
      color: #e74c3c;
      font-weight: 600;
    }

    .balance-positive {
      color: #27ae60;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="header-section">
    <h2><i class="bi bi-people"></i> Customers Management</h2>
    <p>Manage your customer database and track customer balances</p>
  </div>

  <!-- Statistics Cards -->
  <div class="row" id="statsSection">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total Customers</div>
        <div class="stat-value" id="totalCustomers">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Active Customers</div>
        <div class="stat-value" id="activeCustomers">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">With Debt</div>
        <div class="stat-value balance-negative" id="customersWithDebt">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total Debt</div>
        <div class="stat-value balance-negative" id="totalDebt">Ksh 0.00</div>
      </div>
    </div>
  </div>

  <!-- Customer Selection and Actions -->
  <div class="filter-section">
    <div class="row g-3 align-items-end">
      <div class="col-md-2 d-grid gap-2">
        <button class="btn btn-success" onclick="showAddCustomerModal()">
          <i class="bi bi-person-plus"></i> Add
        </button>
        <button class="btn btn-primary" onclick="loadCustomers()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
      <div class="col-md-3">
        <label for="customerEditSelect" class="form-label">-- Select Customer to Edit --</label>
        <div class="d-flex gap-2">
          <select class="form-select" id="customerEditSelect" onchange="updateCustomerActionButtons()">
            <option value="">-- Select Customer to Edit --</option>
          </select>
          <button type="button" class="btn btn-warning" id="editCustomerBtn" onclick="editSelectedCustomer()" disabled>
            <i class="bi bi-pencil"></i> Edit
          </button>
        </div>
      </div>
      <div class="col-md-3">
        <label for="customerPaymentSelect" class="form-label">-- Select Customer to Receive Payment --</label>
        <div class="d-flex gap-2">
          <select class="form-select" id="customerPaymentSelect" onchange="updateCustomerActionButtons()">
            <option value="">-- Select Customer to Receive Payment --</option>
          </select>
          <button type="button" class="btn btn-success" id="receivePaymentBtn" onclick="receiveSelectedPayment()" disabled>
            <i class="bi bi-cash"></i> Receive
          </button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="customerStatementSelect" class="form-label">-- Select Customer for Statement --</label>
        <div class="d-flex gap-2">
          <select class="form-select" id="customerStatementSelect" onchange="updateCustomerActionButtons()">
            <option value="">-- Select Customer for Statement --</option>
          </select>
          <button type="button" class="btn btn-info" id="customerStatementBtn" onclick="viewSelectedCustomerStatement()" disabled>
            <i class="bi bi-file-text"></i> Statement
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <div class="row">
      <div class="col-md-6 col-lg-4">
        <input type="text" class="form-control" id="searchInput" placeholder="Search by name, phone, or email...">
      </div>
      <div class="col-md-3 col-lg-2">
        <select class="form-select" id="statusFilter">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Customers Table -->
  <div class="card">
    <div class="card-header">
      <i class="bi bi-list-ul"></i> Customers List
    </div>
    <div class="card-body">
      <div id="loadingIndicator" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading customers...</p>
      </div>

      <div id="customersTableContainer" style="display: none;">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Customer ID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Location</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <!-- Data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="noDataMessage" style="display: none;" class="text-center text-muted py-4">
        <i class="bi bi-inbox" style="font-size: 48px;"></i>
        <p class="mt-3">No customers found</p>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customerModalTitle"><i class="bi bi-person-plus"></i> Add New Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addCustomerForm" onsubmit="submitCustomer(event)">
          <div class="modal-body">
            <div class="mb-3">
              <label for="custName" class="form-label">Customer Name *</label>
              <input type="text" class="form-control" id="custName" required>
            </div>
            <div class="mb-3">
              <label for="custPhone" class="form-label">Phone Number *</label>
              <input type="text" class="form-control" id="custPhone" required>
            </div>
            <div class="mb-3">
              <label for="custEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="custEmail">
            </div>
            <div class="mb-3">
              <label for="custLocation" class="form-label">Location</label>
              <input type="text" class="form-control" id="custLocation">
            </div>
            <div class="mb-3">
              <label for="custKRAPin" class="form-label">KRA PIN</label>
              <input type="text" class="form-control" id="custKRAPin">
            </div>
            <div class="mb-3">
              <label for="custType" class="form-label">Customer Type</label>
              <select class="form-select" id="custType">
                <option value="Walk-in">Walk-in</option>
                <option value="Regular">Regular</option>
                <option value="Corporate">Corporate</option>
                <option value="Wholesale">Wholesale</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="custCreditLimit" class="form-label">Credit Limit (KSh)</label>
              <input type="number" class="form-control" id="custCreditLimit" value="0" min="0" step="0.01">
            </div>
            <div id="addCustomerAlert" class="alert mt-3" style="display: none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="customerSubmitBtn">
              <i class="bi bi-save"></i> Save Customer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Receive Payment Modal -->
  <div class="modal fade" id="customerPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-cash-coin"></i> Receive Customer Payment</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="paymentCustomerId">
          <div class="alert alert-info mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>Customer:</strong> <span id="paymentCustomerName"></span>
              </div>
              <div>
                <strong>Balance:</strong> <span id="paymentCustomerBalance" class="balance-negative"></span>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="customerPaymentAmount" class="form-label">Payment Amount (Ksh) *</label>
            <input type="number" class="form-control" id="customerPaymentAmount" min="0" step="0.01" required>
            <div class="form-text">Enter the amount received from the customer</div>
          </div>

          <div class="mb-3">
            <label for="customerPaymentAccount" class="form-label">Payment Method *</label>
            <select class="form-select" id="customerPaymentAccount" required>
              <option value="Cash">Cash</option>
              <option value="M-Pesa">M-Pesa</option>
              <option value="Equity Bank">Equity Bank</option>
            </select>
            <div class="form-text">Select the account receiving this payment</div>
          </div>

          <div class="mb-3">
            <label for="customerPaymentReference" class="form-label">Reference/Receipt No</label>
            <input type="text" class="form-control" id="customerPaymentReference" placeholder="e.g., TXN123456">
            <div class="form-text">Optional: M-Pesa code, receipt number, or transfer reference</div>
          </div>

          <div class="mb-3">
            <label for="customerPaymentNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="customerPaymentNotes" rows="2" placeholder="Optional payment notes"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="submitCustomerPaymentBtn" onclick="submitCustomerPayment()">
            <i class="bi bi-check-circle"></i> Submit Payment
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Statement Modal -->
  <div class="modal fade" id="customerStatementModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> Customer Statement</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" id="customerStatementStartDate">
            </div>
            <div class="col-md-4">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" id="customerStatementEndDate">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-primary w-100" onclick="filterCustomerStatement()">
                <i class="bi bi-filter"></i> Apply Filter
              </button>
            </div>
          </div>

          <div class="alert alert-secondary">
            <div class="row">
              <div class="col-md-6">
                <p class="mb-1"><strong>Customer:</strong> <span id="statementCustomerName"></span></p>
                <p class="mb-1"><strong>Customer ID:</strong> <span id="statementCustomerId"></span></p>
                <p class="mb-1"><strong>Phone:</strong> <span id="statementCustomerPhone"></span></p>
              </div>
              <div class="col-md-6 text-md-end">
                <p class="mb-1"><strong>Opening Balance:</strong> <span id="statementOpeningBalance"></span></p>
                <p class="mb-1"><strong>Total Debits (Sales):</strong> <span id="statementDebits"></span></p>
                <p class="mb-1"><strong>Total Credits (Payments):</strong> <span id="statementCredits"></span></p>
                <p class="mb-0"><strong>Closing Balance:</strong> <span id="statementClosingBalance"></span></p>
              </div>
            </div>
          </div>

          <div id="customerStatementLoading" class="text-center py-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Reference</th>
                  <th class="text-end">Debit</th>
                  <th class="text-end">Credit</th>
                  <th class="text-end">Balance</th>
                </tr>
              </thead>
              <tbody id="customerStatementBody">
                <tr><td colspan="7" class="text-center text-muted">No transactions found</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Load customers on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadCustomers();
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('keyup', filterCustomers);
    document.getElementById('statusFilter').addEventListener('change', filterCustomers);

    let customersData = [];
    let editingCustomerId = null;
    let currentStatementCustomerId = null;

    function loadCustomers() {
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('customersTableContainer').style.display = 'none';
      document.getElementById('noDataMessage').style.display = 'none';

      google.script.run
        .withSuccessHandler(function(data) {
          customersData = data;
          displayCustomers(data);
          updateStats(data);
          populateCustomerDropdown(data);
          document.getElementById('loadingIndicator').style.display = 'none';
        })
        .withFailureHandler(function(error) {
          document.getElementById('loadingIndicator').innerHTML =
            '<div class="alert alert-danger">Error loading customers: ' + error.message + '</div>';
        })
        .getCustomers({});
    }

    function displayCustomers(data) {
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        document.getElementById('noDataMessage').style.display = 'block';
        return;
      }

      document.getElementById('customersTableContainer').style.display = 'block';

      data.forEach(function(customer) {
        const row = document.createElement('tr');

        const balance = parseFloat(customer.Current_Balance || customer.Balance || 0);
        const balanceClass = balance < 0 ? 'balance-negative' : balance > 0 ? 'balance-positive' : '';
        const balanceText = balance < 0 ? 'Owes: Ksh ' + Math.abs(balance).toFixed(2) :
                           balance > 0 ? 'Credit: Ksh ' + balance.toFixed(2) : 'Ksh 0.00';

        const statusBadge = customer.Status === 'Active' ?
          '<span class="badge bg-success">Active</span>' :
          '<span class="badge bg-secondary">Inactive</span>';

        row.innerHTML = `
          <td>${customer.Customer_ID || ''}</td>
          <td><strong>${customer.Customer_Name || customer.Name || ''}</strong></td>
          <td>${customer.Phone || '-'}</td>
          <td>${customer.Email || '-'}</td>
          <td>${customer.Location || '-'}</td>
          <td class="${balanceClass}">${balanceText}</td>
          <td>${statusBadge}</td>
          <td>
            <button class="btn btn-sm btn-primary me-1" onclick='viewCustomer("${customer.Customer_ID}")' title="View Details">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-success me-1" onclick='openPaymentModal("${customer.Customer_ID}")' title="Record Payment" ${balance >= 0 ? 'disabled' : ''}>
              <i class="bi bi-cash"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick='openCustomerEditor("${customer.Customer_ID}")' title="Edit">
              <i class="bi bi-pencil"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateStats(data) {
      if (!data || data.length === 0) {
        return;
      }

      const totalCustomers = data.length;
      const activeCustomers = data.filter(c => c.Status === 'Active').length;
      let customersWithDebt = 0;
      let totalDebt = 0;

      data.forEach(function(customer) {
        const balance = parseFloat(customer.Current_Balance || customer.Balance || 0);
        if (balance < 0) {
          customersWithDebt++;
          totalDebt += Math.abs(balance);
        }
      });

      document.getElementById('totalCustomers').textContent = totalCustomers;
      document.getElementById('activeCustomers').textContent = activeCustomers;
      document.getElementById('customersWithDebt').textContent = customersWithDebt;
      document.getElementById('totalDebt').textContent = 'Ksh ' + totalDebt.toFixed(2);
    }

    function filterCustomers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      const filtered = customersData.filter(function(customer) {
        const matchesSearch = !searchTerm ||
          (customer.Name && customer.Name.toLowerCase().includes(searchTerm)) ||
          (customer.Phone && customer.Phone.includes(searchTerm)) ||
          (customer.Email && customer.Email.toLowerCase().includes(searchTerm)) ||
          (customer.Customer_ID && customer.Customer_ID.toLowerCase().includes(searchTerm));

        const matchesStatus = !statusFilter || customer.Status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      displayCustomers(filtered);
      updateStats(filtered);
    }

    // Get current user
    let currentUser = sessionStorage.getItem('userName') || 'SYSTEM';

    // Show Add Customer Modal
    function showAddCustomerModal() {
      editingCustomerId = null;
      document.getElementById('addCustomerForm').reset();
      document.getElementById('addCustomerAlert').style.display = 'none';
      document.getElementById('customerModalTitle').innerHTML = '<i class="bi bi-person-plus"></i> Add New Customer';
      document.getElementById('customerSubmitBtn').innerHTML = '<i class="bi bi-save"></i> Save Customer';
      const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
      modal.show();
    }

    // Submit Customer
    function submitCustomer(event) {
      if (event) event.preventDefault();
      const name = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail').value.trim();
      const location = document.getElementById('custLocation').value.trim();
      const kraPin = document.getElementById('custKRAPin').value.trim();
      const type = document.getElementById('custType').value;
      const creditLimit = document.getElementById('custCreditLimit').value;

      if (!name || !phone) {
        showCustomerAlert('Please fill in all required fields (Name and Phone)', 'warning');
        return;
      }

      const customerData = {
        Customer_Name: name,
        Phone: phone,
        Email: email,
        Location: location,
        KRA_PIN: kraPin,
        Customer_Type: type,
        Credit_Limit: parseFloat(creditLimit) || 0,
        Created_By: currentUser,
        User: currentUser
      };

      // Show loading state
      showCustomerAlert(editingCustomerId ? 'Updating customer...' : 'Adding customer...', 'info');

      const runner = google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showCustomerAlert(editingCustomerId ? 'Customer updated successfully!' : 'Customer added successfully!', 'success');
            setTimeout(function() {
              bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
              loadCustomers(); // Refresh the customer list
            }, 1000);
          } else {
            showCustomerAlert('Error: ' + result.message, 'danger');
          }
        })
        .withFailureHandler(function(error) {
          showCustomerAlert('Error: ' + error.message, 'danger');
        });

      if (editingCustomerId) {
        runner.updateCustomer(editingCustomerId, customerData);
      } else {
        runner.addCustomer(customerData);
      }
    }

    // Helper function to show alerts in customer modal
    function showCustomerAlert(message, type) {
      const alertDiv = document.getElementById('addCustomerAlert');
      alertDiv.className = 'alert alert-' + type + ' mt-3';
      alertDiv.textContent = message;
      alertDiv.style.display = 'block';
    }

    // View customer details
    function viewCustomer(customerId) {
      alert('View customer details for: ' + customerId + '\n\nThis feature will show detailed customer information, purchase history, and payment records.');
    }

    function populateCustomerDropdown(data) {
      const actionSelects = [
        { id: 'customerEditSelect', placeholder: '-- Select Customer to Edit --' },
        { id: 'customerPaymentSelect', placeholder: '-- Select Customer to Receive Payment --' },
        { id: 'customerStatementSelect', placeholder: '-- Select Customer for Statement --' }
      ];

      if (!data || data.length === 0) {
        actionSelects.forEach(({ id, placeholder }) => {
          const select = document.getElementById(id);
          if (select) select.innerHTML = `<option value="">${placeholder}</option>`;
        });
        updateCustomerActionButtons();
        return;
      }

      const sorted = [...data].sort((a, b) => {
        const nameA = (a.Customer_Name || a.Name || '').toLowerCase();
        const nameB = (b.Customer_Name || b.Name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });

      actionSelects.forEach(({ id, placeholder }) => {
        const select = document.getElementById(id);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = `<option value="">${placeholder}</option>`;

        sorted.forEach(customer => {
          const option = document.createElement('option');
          option.value = customer.Customer_ID;
          option.textContent = `${customer.Customer_Name || customer.Name || ''} (${customer.Customer_ID})`;
          select.appendChild(option);
        });

        if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
          select.value = currentValue;
        }
      });

      updateCustomerActionButtons();
    }

    function updateCustomerActionButtons() {
      const editSelect = document.getElementById('customerEditSelect');
      document.getElementById('editCustomerBtn').disabled = !(editSelect && editSelect.value);

      const paymentSelect = document.getElementById('customerPaymentSelect');
      const paymentCustomer = paymentSelect ? findCustomerById(paymentSelect.value) : null;
      const paymentBalance = paymentCustomer ? getNumericField(paymentCustomer, ['Current_Balance', 'Balance']) : 0;
      document.getElementById('receivePaymentBtn').disabled = !(paymentCustomer && paymentBalance < 0);

      const statementSelect = document.getElementById('customerStatementSelect');
      document.getElementById('customerStatementBtn').disabled = !(statementSelect && statementSelect.value);
    }

    function getSelectedCustomerId(selectId, actionText) {
      const select = document.getElementById(selectId);
      if (!select || !select.value) {
        alert(`Please select a customer ${actionText}`);
        return null;
      }
      return select.value;
    }

    function editSelectedCustomer() {
      const customerId = getSelectedCustomerId('customerEditSelect', 'to edit');
      if (!customerId) return;
      openCustomerEditor(customerId);
    }

    function receiveSelectedPayment() {
      const customerId = getSelectedCustomerId('customerPaymentSelect', 'to receive payment from');
      if (!customerId) return;
      openPaymentModal(customerId);
    }

    function viewSelectedCustomerStatement() {
      const customerId = getSelectedCustomerId('customerStatementSelect', 'for the statement');
      if (!customerId) return;
      viewCustomerStatement(customerId);
    }

    function findCustomerById(customerId) {
      if (!customerId) return null;
      return customersData.find(c => c.Customer_ID === customerId) || null;
    }

    function getNumericField(record, fields) {
      for (let i = 0; i < fields.length; i++) {
        const value = record[fields[i]];
        if (value !== undefined && value !== null && value !== '') {
          const num = parseFloat(value);
          if (!isNaN(num)) return num;
        }
      }
      return 0;
    }

    function openCustomerEditor(customerId) {
      const customer = customersData.find(c => c.Customer_ID === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      editingCustomerId = customerId;
      document.getElementById('customerModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Customer';
      document.getElementById('customerSubmitBtn').innerHTML = '<i class="bi bi-check-circle"></i> Update Customer';

      document.getElementById('custName').value = customer.Customer_Name || customer.Name || '';
      document.getElementById('custPhone').value = customer.Phone || '';
      document.getElementById('custEmail').value = customer.Email || '';
      document.getElementById('custLocation').value = customer.Location || '';
      document.getElementById('custKRAPin').value = customer.KRA_PIN || '';
      document.getElementById('custType').value = customer.Customer_Type || 'Walk-in';
      const creditLimit = getNumericField(customer, ['Credit_Limit', 'Credit Limit']);
      document.getElementById('custCreditLimit').value = creditLimit || 0;

      const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
      modal.show();
    }

    function openPaymentModal(customerId) {
      const customer = customersData.find(c => c.Customer_ID === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      document.getElementById('paymentCustomerId').value = customerId;
      document.getElementById('paymentCustomerName').textContent = customer.Customer_Name || customer.Name || '';
      const balance = getNumericField(customer, ['Current_Balance', 'Balance']);
      document.getElementById('paymentCustomerBalance').textContent = 'Ksh ' + balance.toFixed(2);
      document.getElementById('customerPaymentAmount').value = Math.abs(balance).toFixed(2);
      document.getElementById('customerPaymentAccount').value = 'Cash';
      document.getElementById('customerPaymentReference').value = '';
      document.getElementById('customerPaymentNotes').value = '';

      const modal = new bootstrap.Modal(document.getElementById('customerPaymentModal'));
      modal.show();
    }

    function submitCustomerPayment() {
      const customerId = document.getElementById('paymentCustomerId').value;
      const amount = parseFloat(document.getElementById('customerPaymentAmount').value);
      const account = document.getElementById('customerPaymentAccount').value;
      const reference = document.getElementById('customerPaymentReference').value.trim();
      const notes = document.getElementById('customerPaymentNotes').value.trim();

      if (!customerId) {
        alert('No customer selected');
        return;
      }

      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid payment amount');
        return;
      }

      const submitBtn = document.getElementById('submitCustomerPaymentBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

      const paymentData = {
        Customer_ID: customerId,
        Amount: amount,
        Account: account,
        Reference: reference,
        Receipt_No: reference,
        Notes: notes,
        User: currentUser
      };

      google.script.run
        .withSuccessHandler(function(result) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Payment';

          if (result.success) {
            alert('Payment recorded successfully!');
            bootstrap.Modal.getInstance(document.getElementById('customerPaymentModal')).hide();
            loadCustomers();
          } else {
            alert('Error: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Payment';
          alert('Error recording payment: ' + error.message);
        })
        .recordCustomerPayment(paymentData);
    }

    function viewCustomerStatement(customerId) {
      const customer = customersData.find(c => c.Customer_ID === customerId);
      if (!customer) {
        alert('Customer not found');
        return;
      }

      currentStatementCustomerId = customerId;
      document.getElementById('customerStatementStartDate').value = '';
      document.getElementById('customerStatementEndDate').value = '';

      document.getElementById('statementCustomerName').textContent = customer.Customer_Name || customer.Name || '';
      document.getElementById('statementCustomerId').textContent = customer.Customer_ID;
      document.getElementById('statementCustomerPhone').textContent = customer.Phone || '-';

      document.getElementById('customerStatementLoading').style.display = 'block';
      document.getElementById('customerStatementBody').innerHTML = '<tr><td colspan="7" class="text-center text-muted">Loading statement...</td></tr>';

      const modal = new bootstrap.Modal(document.getElementById('customerStatementModal'));
      modal.show();

      loadCustomerStatementData(customerId, null, null);
    }

    function loadCustomerStatementData(customerId, startDate, endDate) {
      document.getElementById('customerStatementLoading').style.display = 'block';

      google.script.run
        .withSuccessHandler(function(statement) {
          displayCustomerStatement(statement);
          document.getElementById('customerStatementLoading').style.display = 'none';
        })
        .withFailureHandler(function(error) {
          document.getElementById('customerStatementBody').innerHTML = '<tr><td colspan="7" class="text-danger">Error loading statement: ' + error.message + '</td></tr>';
          document.getElementById('customerStatementLoading').style.display = 'none';
        })
        .getCustomerStatement(customerId, startDate, endDate);
    }

    function filterCustomerStatement() {
      if (!currentStatementCustomerId) {
        alert('No customer statement is currently loaded');
        return;
      }

      const start = document.getElementById('customerStatementStartDate').value || null;
      const end = document.getElementById('customerStatementEndDate').value || null;
      loadCustomerStatementData(currentStatementCustomerId, start, end);
    }

    function displayCustomerStatement(statement) {
      const customer = statement.customer;

      document.getElementById('statementCustomerName').textContent = customer.Customer_Name || customer.Name || '';
      document.getElementById('statementCustomerId').textContent = customer.Customer_ID || '';
      document.getElementById('statementCustomerPhone').textContent = customer.Phone || '-';

      document.getElementById('statementOpeningBalance').textContent = 'Ksh ' + (statement.openingBalance || 0).toFixed(2);
      document.getElementById('statementDebits').textContent = 'Ksh ' + (statement.totalDebits || 0).toFixed(2);
      document.getElementById('statementCredits').textContent = 'Ksh ' + (statement.totalCredits || 0).toFixed(2);
      document.getElementById('statementClosingBalance').textContent = 'Ksh ' + (statement.closingBalance || 0).toFixed(2);

      const tbody = document.getElementById('customerStatementBody');
      tbody.innerHTML = '';

      if (!statement.transactions || statement.transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transactions found</td></tr>';
        return;
      }

      statement.transactions.forEach(txn => {
        const row = document.createElement('tr');
        const date = new Date(txn.date);
        const debit = txn.debit || 0;
        const credit = txn.credit || 0;
        const balance = txn.balance || 0;
        const balanceClass = balance > 0 ? 'balance-negative' : balance < 0 ? 'balance-positive' : '';

        row.innerHTML = `
          <td>${date.toLocaleDateString('en-GB')}</td>
          <td><span class="badge ${txn.type === 'Sale' ? 'bg-danger' : 'bg-success'}">${txn.type}</span></td>
          <td>${txn.description || '-'}</td>
          <td>${txn.reference || '-'}</td>
          <td class="text-end">${debit > 0 ? 'Ksh ' + debit.toFixed(2) : '-'}</td>
          <td class="text-end">${credit > 0 ? 'Ksh ' + credit.toFixed(2) : '-'}</td>
          <td class="text-end ${balanceClass}"><strong>Ksh ${balance.toFixed(2)}</strong></td>
        `;

        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
