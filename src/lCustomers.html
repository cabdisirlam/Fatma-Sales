<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Management</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      padding: 20px;
    }

    /* Header */
    .header-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Clean Stat Cards (Matches Supplier Look) */
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      height: 100%;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin: 10px 0;
    }

    .stat-label {
      color: #7f8c8d;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Colors */
    .text-success-custom { color: #27ae60; }
    .text-danger-custom { color: #e74c3c; }
    .text-primary-custom { color: #667eea; }
    .text-warning-custom { color: #f39c12; }

    /* Action Rows Layout */
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* The 3-Row Layout Styles */
    .action-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    .action-row:last-child {
      margin-bottom: 0;
    }

    .action-select {
      flex-grow: 1;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      height: 40px;
    }

    .btn-action {
      min-width: 140px;
      height: 40px;
      font-weight: 500;
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .btn-action:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      color: white;
    }

    /* Specific Button Colors to match Screenshot */
    .btn-edit-custom { background-color: #f1c40f; color: #2c3e50; } /* Yellow */
    .btn-pay-custom { background-color: #198754; } /* Green */
    .btn-stmt-custom { background-color: #0dcaf0; color: #2c3e50; } /* Cyan */

    /* Tables & General */
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px 15px 0 0 !important;
      padding: 15px 20px;
      font-weight: 600;
    }

    .table thead { background: #f8f9fa; }
    .table th {
      border-bottom: 2px solid #dee2e6;
      color: #2c3e50;
      font-weight: 600;
      padding: 12px;
    }
    .table td { padding: 12px; vertical-align: middle; }

    .balance-negative { color: #e74c3c; font-weight: 600; }
    .balance-positive { color: #27ae60; font-weight: 600; }

    /* Loading Overlay */
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }
  </style>
</head>
<body>
  <div class="header-section">
    <h2 style="margin:0; font-weight: 700;"><i class="bi bi-people"></i> Customer Management</h2>
    <p style="margin: 5px 0 0 0; opacity: 0.9;">Manage customers, track balances, and record payments</p>
  </div>

  <div class="row mb-4" id="statsSection">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total Customers</div>
        <div class="stat-value text-primary-custom" id="totalCustomers">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Active Customers</div>
        <div class="stat-value text-success-custom" id="activeCustomers">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total Receivable (Debt)</div>
        <div class="stat-value text-danger-custom" id="totalReceivable">Ksh 0.00</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-label">Total Sales Volume</div>
        <div class="stat-value text-primary-custom" id="totalSales">Ksh 0.00</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="filter-section">
        <h6 class="mb-3 text-muted fw-bold">ACTIONS</h6>
        
        <div class="action-row">
          <select class="form-select action-select" id="selectCustomerEdit">
            <option value="">Select Customer to Edit...</option>
          </select>
          <button class="btn btn-action btn-edit-custom" onclick="actionEdit()">
            <i class="bi bi-pencil"></i> Edit
          </button>
        </div>

        <div class="action-row">
          <select class="form-select action-select" id="selectCustomerPay">
            <option value="">Select Customer - Balance...</option>
          </select>
          <button class="btn btn-action btn-pay-custom" onclick="actionReceive()">
            <i class="bi bi-cash-coin"></i> Receive
          </button>
        </div>

        <div class="action-row">
          <select class="form-select action-select" id="selectCustomerStmt">
            <option value="">Select Customer for Statement...</option>
          </select>
          <button class="btn btn-action btn-stmt-custom" onclick="actionStatement()">
            <i class="bi bi-file-text"></i> Statement
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="filter-section" style="height: 100%;">
        <h6 class="mb-3 text-muted fw-bold">FILTERS & NEW</h6>
        <div class="mb-3">
          <input type="text" class="form-control" id="searchInput" placeholder="Search by name, phone, or email..." style="height: 45px;">
        </div>
        <div class="mb-3">
          <select class="form-select" id="statusFilter" style="height: 45px;">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-grow-1" onclick="loadCustomers()">
            <i class="bi bi-arrow-clockwise"></i> Refresh List
          </button>
          <button class="btn btn-success flex-grow-1" onclick="showAddCustomerModal()">
            <i class="bi bi-plus-circle"></i> Add New Customer
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-2">
    <div class="card-header">
      <i class="bi bi-list-ul"></i> Customers List
    </div>
    <div class="card-body p-0">
      <div id="loadingIndicator" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading customers...</p>
      </div>

      <div id="customersTableContainer" style="display: none;">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Customer ID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Location</th>
                <th>Balance</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="customersTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="noDataMessage" style="display: none;" class="text-center text-muted py-5">
        <i class="bi bi-inbox" style="font-size: 48px;"></i>
        <p class="mt-3">No customers found</p>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customerModalTitle"><i class="bi bi-person-plus"></i> Add New Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addCustomerForm" onsubmit="submitCustomer(event)">
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Customer Name *</label>
                <input type="text" class="form-control" id="custName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone Number *</label>
                <input type="text" class="form-control" id="custPhone" required>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="custEmail">
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input type="text" class="form-control" id="custLocation">
              </div>
              <div class="col-md-6">
                <label class="form-label">KRA PIN</label>
                <input type="text" class="form-control" id="custKRAPin">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Customer Type</label>
                <select class="form-select" id="custType">
                  <option value="Walk-in">Walk-in</option>
                  <option value="Regular">Regular</option>
                  <option value="Corporate">Corporate</option>
                  <option value="Wholesale">Wholesale</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Credit Limit (KSh)</label>
                <input type="number" class="form-control" id="custCreditLimit" value="0" min="0">
              </div>
            </div>

            <div class="mb-3 p-3 bg-light rounded border">
              <label class="form-label text-primary fw-bold">Opening Balance (Optional)</label>
              <input type="number" class="form-control" id="custOpeningBalance" placeholder="0.00" step="0.01">
              <div class="form-text">Enter amount if customer already owes money.</div>
            </div>

            <div id="addCustomerAlert" class="alert mt-3" style="display: none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="customerSubmitBtn">
              <i class="bi bi-save"></i> Save Customer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customerPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-cash-coin"></i> Receive Payment</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="paymentCustomerId">
          <div class="alert alert-light border text-center mb-3">
            <h5 id="paymentCustomerName" class="mb-1 fw-bold"></h5>
            <div id="paymentCustomerBalance" class="fs-4 fw-bold text-danger"></div>
            <small class="text-muted">Current Outstanding Balance</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Amount (Ksh) *</label>
            <input type="number" class="form-control form-control-lg" id="customerPaymentAmount" min="0" step="0.01" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Method *</label>
            <select class="form-select" id="customerPaymentAccount" required>
              <option value="Cash">Cash</option>
              <option value="M-Pesa">M-Pesa</option>
              <option value="Equity Bank">Equity Bank</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Reference / Receipt No</label>
            <input type="text" class="form-control" id="customerPaymentReference" placeholder="e.g. QH823...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success px-4" id="submitCustomerPaymentBtn" onclick="submitCustomerPayment()">
            Confirm Payment
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let customersData = [];
    let editingCustomerId = null;
    let currentUser = sessionStorage.getItem('userName') || 'SYSTEM';

    document.addEventListener('DOMContentLoaded', function() {
      loadCustomers();
      document.getElementById('searchInput').addEventListener('keyup', filterCustomers);
      document.getElementById('statusFilter').addEventListener('change', filterCustomers);
    });

    function loadCustomers() {
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('customersTableContainer').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(data) {
          customersData = data;
          displayCustomers(data);
          updateStats(data);
          populateDropdowns(data);
          document.getElementById('loadingIndicator').style.display = 'none';
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .getCustomers({});
    }

    function populateDropdowns(data) {
      const selectEdit = document.getElementById('selectCustomerEdit');
      const selectPay = document.getElementById('selectCustomerPay');
      const selectStmt = document.getElementById('selectCustomerStmt');

      // Reset
      selectEdit.innerHTML = '<option value="">Select Customer to Edit...</option>';
      selectPay.innerHTML = '<option value="">Select Customer - Balance...</option>';
      selectStmt.innerHTML = '<option value="">Select Customer for Statement...</option>';

      if (!data || data.length === 0) return;

      const sorted = [...data].sort((a, b) => (a.Customer_Name || '').localeCompare(b.Customer_Name || ''));

      sorted.forEach(c => {
        const name = c.Customer_Name || c.Name;
        const id = c.Customer_ID;
        const balance = parseFloat(c.Current_Balance || c.Balance || 0);
        
        let balText = ' - Bal: 0';
        if (balance < 0) balText = ` - Owes: ${Math.abs(balance).toLocaleString()}`;
        if (balance > 0) balText = ` - Credit: ${balance.toLocaleString()}`;

        selectEdit.add(new Option(`${name}`, id));
        selectPay.add(new Option(`${name}${balText}`, id));
        selectStmt.add(new Option(`${name}`, id));
      });
    }

    function displayCustomers(data) {
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        document.getElementById('noDataMessage').style.display = 'block';
        return;
      }
      document.getElementById('noDataMessage').style.display = 'none';
      document.getElementById('customersTableContainer').style.display = 'block';

      data.forEach(c => {
        const row = document.createElement('tr');
        const balance = parseFloat(c.Current_Balance || c.Balance || 0);
        
        let balHtml = '<span class="text-muted">0.00</span>';
        if (balance < 0) balHtml = `<span class="balance-negative">Owes ${Math.abs(balance).toLocaleString()}</span>`;
        if (balance > 0) balHtml = `<span class="balance-positive">Credit ${balance.toLocaleString()}</span>`;

        row.innerHTML = `
          <td>${c.Customer_ID}</td>
          <td><strong>${c.Customer_Name}</strong></td>
          <td>${c.Phone}</td>
          <td>${c.Location || '-'}</td>
          <td>${balHtml}</td>
          <td><span class="badge ${c.Status === 'Active' ? 'bg-success' : 'bg-secondary'}">${c.Status}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateStats(data) {
      if(!data) return;
      const total = data.length;
      const active = data.filter(c => c.Status === 'Active').length;
      let debt = 0;
      let sales = 0;

      data.forEach(c => {
        const bal = parseFloat(c.Current_Balance || 0);
        if (bal < 0) debt += Math.abs(bal);
        sales += parseFloat(c.Total_Purchases || 0);
      });

      document.getElementById('totalCustomers').textContent = total;
      document.getElementById('activeCustomers').textContent = active;
      document.getElementById('totalReceivable').textContent = 'Ksh ' + debt.toLocaleString();
      document.getElementById('totalSales').textContent = 'Ksh ' + sales.toLocaleString();
    }

    function filterCustomers() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;

      const filtered = customersData.filter(c => {
        const matchTerm = (c.Customer_Name && c.Customer_Name.toLowerCase().includes(term)) ||
                          (c.Phone && c.Phone.includes(term));
        const matchStatus = !status || c.Status === status;
        return matchTerm && matchStatus;
      });
      displayCustomers(filtered);
    }

    // ACTIONS
    function actionEdit() {
      const id = document.getElementById('selectCustomerEdit').value;
      if(!id) return alert("Select a customer first");
      const c = customersData.find(x => x.Customer_ID === id);
      
      editingCustomerId = id;
      document.getElementById('customerModalTitle').innerText = 'Edit Customer';
      document.getElementById('customerSubmitBtn').innerText = 'Update Customer';
      
      document.getElementById('custName').value = c.Customer_Name;
      document.getElementById('custPhone').value = c.Phone;
      document.getElementById('custEmail').value = c.Email || '';
      document.getElementById('custLocation').value = c.Location || '';
      document.getElementById('custKRAPin').value = c.KRA_PIN || '';
      document.getElementById('custType').value = c.Customer_Type || 'Walk-in';
      document.getElementById('custCreditLimit').value = c.Credit_Limit || 0;
      
      document.getElementById('custOpeningBalance').parentElement.style.display = 'none'; // Hide on edit
      new bootstrap.Modal(document.getElementById('addCustomerModal')).show();
    }

    function actionReceive() {
      const id = document.getElementById('selectCustomerPay').value;
      if(!id) return alert("Select a customer first");
      const c = customersData.find(x => x.Customer_ID === id);
      const balance = parseFloat(c.Current_Balance || 0);

      document.getElementById('paymentCustomerId').value = id;
      document.getElementById('paymentCustomerName').innerText = c.Customer_Name;
      document.getElementById('paymentCustomerBalance').innerText = 'Ksh ' + Math.abs(balance).toLocaleString();
      document.getElementById('customerPaymentAmount').value = balance < 0 ? Math.abs(balance) : '';
      
      new bootstrap.Modal(document.getElementById('customerPaymentModal')).show();
    }

    function actionStatement() {
      const id = document.getElementById('selectCustomerStmt').value;
      if(!id) return alert("Select a customer first");
      // Placeholder for statement modal logic
      alert("Statement feature coming soon for " + id);
    }

    function showAddCustomerModal() {
      editingCustomerId = null;
      document.getElementById('addCustomerForm').reset();
      document.getElementById('customerModalTitle').innerText = 'Add New Customer';
      document.getElementById('customerSubmitBtn').innerText = 'Save Customer';
      document.getElementById('custOpeningBalance').parentElement.style.display = 'block';
      new bootstrap.Modal(document.getElementById('addCustomerModal')).show();
    }

    function submitCustomer(e) {
      e.preventDefault();
      const btn = document.getElementById('customerSubmitBtn');
      btn.disabled = true;
      btn.innerText = 'Saving...';

      const data = {
        Customer_Name: document.getElementById('custName').value,
        Phone: document.getElementById('custPhone').value,
        Email: document.getElementById('custEmail').value,
        Location: document.getElementById('custLocation').value,
        KRA_PIN: document.getElementById('custKRAPin').value,
        Customer_Type: document.getElementById('custType').value,
        Credit_Limit: document.getElementById('custCreditLimit').value,
        Opening_Balance: document.getElementById('custOpeningBalance').value,
        User: currentUser
      };

      const handler = editingCustomerId 
        ? google.script.run.withSuccessHandler(onSave).withFailureHandler(onError).updateCustomer(editingCustomerId, data)
        : google.script.run.withSuccessHandler(onSave).withFailureHandler(onError).addCustomer(data);

      function onSave(res) {
        btn.disabled = false;
        if(res.success) {
          bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
          loadCustomers();
          alert(res.message);
        } else {
          alert(res.message);
        }
      }
      function onError(err) { btn.disabled = false; alert(err.message); }
    }

    function submitCustomerPayment() {
      const id = document.getElementById('paymentCustomerId').value;
      const amt = document.getElementById('customerPaymentAmount').value;
      const method = document.getElementById('customerPaymentAccount').value;
      const ref = document.getElementById('customerPaymentReference').value;

      if(!amt || amt <= 0) return alert("Enter valid amount");

      const btn = document.getElementById('submitCustomerPaymentBtn');
      btn.disabled = true;
      btn.innerText = 'Processing...';

      const paymentData = { Customer_ID: id, Amount: amt, Account: method, Reference: ref, User: currentUser };

      google.script.run.withSuccessHandler(res => {
        btn.disabled = false;
        if(res.success) {
          bootstrap.Modal.getInstance(document.getElementById('customerPaymentModal')).hide();
          loadCustomers();
          alert("Payment Recorded!");
        } else alert(res.message);
      }).withFailureHandler(e => { btn.disabled = false; alert(e.message); }).recordCustomerPayment(paymentData);
    }
  </script>
</body>
</html>
