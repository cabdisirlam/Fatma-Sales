<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f6fa; padding: 20px; }
    .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .balance-negative { color: #e74c3c; font-weight: 600; }
    .balance-positive { color: #27ae60; font-weight: 600; }
  </style>
</head>
<body>
  <div class="header-section">
    <h2><i class="bi bi-people"></i> Customer Management</h2>
  </div>

  <div class="card mb-3">
    <div class="card-body d-flex gap-2">
      <input type="text" class="form-control" id="searchInput" placeholder="Search customers...">
      <button class="btn btn-primary" onclick="loadCustomers()">Refresh</button>
      <button class="btn btn-success" onclick="showAddModal()">Add New</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div id="loadingIndicator" class="text-center py-4">
        <div class="spinner-border text-primary"></div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="customersTable" style="display:none;">
          <thead>
            <tr><th>Name</th><th>Phone</th><th>Location</th><th>KRA PIN</th><th>Balance</th><th>Actions</th></tr>
          </thead>
          <tbody id="customersTableBody"></tbody>
        </table>
      </div>
      <div id="noData" class="text-center py-4 text-muted" style="display:none;">No customers found</div>
    </div>
  </div>

  <div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Customer Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="customerForm">
            <input type="hidden" id="custId">
            <div class="mb-2"><label>Name</label><input type="text" class="form-control" id="custName" required></div>
            <div class="mb-2"><label>Phone</label><input type="text" class="form-control" id="custPhone"></div>
            <div class="mb-2"><label>Location</label><input type="text" class="form-control" id="custLocation"></div>
            <div class="mb-2"><label>KRA PIN</label><input type="text" class="form-control" id="custKRA"></div>
            <div class="mb-2" id="balDiv"><label>Opening Balance (Debt)</label><input type="number" class="form-control" id="custBal" placeholder="0.00"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="saveCustomer()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let customersData = [];
    
    window.onload = loadCustomers;

    function loadCustomers() {
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('customersTable').style.display = 'none';
      document.getElementById('noData').style.display = 'none';

      google.script.run
        .withSuccessHandler(renderCustomers)
        .withFailureHandler(error => {
           document.getElementById('loadingIndicator').style.display = 'none';
           alert('Error: ' + error.message);
        })
        .getCustomers({});
    }

    function renderCustomers(data) {
      document.getElementById('loadingIndicator').style.display = 'none';
      customersData = data || [];
      
      if(customersData.length === 0) {
        document.getElementById('noData').style.display = 'block';
        return;
      }

      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';
      
      customersData.forEach(c => {
        const bal = parseFloat(c.Current_Balance || c.Balance || 0);
        let balClass = bal < 0 ? 'balance-negative' : 'text-muted';
        let balText = bal < 0 ? `Owes ${Math.abs(bal)}` : bal;

        tbody.innerHTML += `
          <tr>
            <td>${c.Customer_Name}</td>
            <td>${c.Phone}</td>
            <td>${c.Location || '-'}</td>
            <td>${c.KRA_PIN || '-'}</td>
            <td class="${balClass}">${balText}</td>
            <td><button class="btn btn-sm btn-outline-primary" onclick="editCustomer('${c.Customer_ID}')">Edit</button></td>
          </tr>
        `;
      });
      document.getElementById('customersTable').style.display = 'table';
    }

    function showAddModal() {
      document.getElementById('customerForm').reset();
      document.getElementById('custId').value = '';
      document.getElementById('balDiv').style.display = 'block';
      new bootstrap.Modal(document.getElementById('customerModal')).show();
    }

    function editCustomer(id) {
      const c = customersData.find(x => x.Customer_ID === id);
      if(!c) return;
      document.getElementById('custId').value = id;
      document.getElementById('custName').value = c.Customer_Name;
      document.getElementById('custPhone').value = c.Phone;
      document.getElementById('custLocation').value = c.Location || '';
      document.getElementById('custKRA').value = c.KRA_PIN || '';
      document.getElementById('balDiv').style.display = 'none'; // Hide balance on edit
      new bootstrap.Modal(document.getElementById('customerModal')).show();
    }

    function saveCustomer() {
      const id = document.getElementById('custId').value;
      const data = {
        Customer_Name: document.getElementById('custName').value,
        Phone: document.getElementById('custPhone').value,
        Location: document.getElementById('custLocation').value,
        KRA_PIN: document.getElementById('custKRA').value,
        Opening_Balance: document.getElementById('custBal').value,
        User: sessionStorage.getItem('userName') || 'SYSTEM'
      };

      const handler = id 
        ? google.script.run.withSuccessHandler(onSaved).updateCustomer(id, data)
        : google.script.run.withSuccessHandler(onSaved).addCustomer(data);
    }

    function onSaved(res) {
      if(res.success) {
        bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
        loadCustomers();
      } else {
        alert(res.message);
      }
    }
    
    document.getElementById('searchInput').addEventListener('keyup', function(e) {
      const term = e.target.value.toLowerCase();
      const filtered = customersData.filter(c => 
        (c.Customer_Name + c.Phone + c.Location).toLowerCase().includes(term)
      );
      renderCustomers(filtered);
    });
  </script>
</body>
</html>
