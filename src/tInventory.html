<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --purple-gradient: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            --pink-red-gradient: linear-gradient(135deg, #ff8177 0%, #ff867a 0%, #ff8c7f 21%, #f99185 52%, #cf556c 78%, #b12a5b 100%);
            --cyan-gradient: linear-gradient(135deg, #2af598 0%, #009efd 100%);
            --orange-yellow-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --body-bg: #f0f2f5;
            --card-bg: #ffffff;
            --card-border-color: #e9ecef;
            --text-color: #495057;
            --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
            --shadow: 0 .5rem 1rem rgba(0,0,0,.15);
            --border-radius: .75rem;
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
        }

        .header-banner {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }

        .header-banner .icon {
            font-size: 3rem;
            margin-right: 1.5rem;
        }

        .summary-card {
            border-radius: var(--border-radius);
            color: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease-in-out;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .summary-card .label {
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .bg-gradient-purple { background: var(--purple-gradient); }
        .bg-gradient-pink { background: var(--pink-red-gradient); }
        .bg-gradient-cyan { background: var(--cyan-gradient); }
        .bg-gradient-orange { background: var(--orange-yellow-gradient); }

        .action-bar {
            margin-bottom: 1.5rem;
        }

        .card-table {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--card-border-color);
        }

        .card-table .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .btn-gradient-primary {
            background: var(--primary-gradient);
            border: none;
            color: white;
            transition: opacity 0.3s;
        }

        .btn-gradient-primary:hover {
            opacity: 0.9;
            color: white;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .loader {
            text-align: center;
            padding: 2rem;
        }
        
        .badge-status {
            font-size: 0.8rem;
            padding: 0.4em 0.7em;
        }
        .badge-in-stock {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-low-stock {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-out-of-stock {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 767.98px) {
            .container-fluid { padding: 1rem !important; }

            .header-banner {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
            }

            .header-banner .icon {
                font-size: 2rem;
                margin-right: 0;
                margin-bottom: 0.5rem;
            }

            .header-banner h1 { font-size: 1.5rem; }
            .header-banner p { font-size: 0.9rem; }

            .summary-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .summary-card .value { font-size: 1.5rem; }
            .summary-card .label { font-size: 0.8rem; }

            /* Make action bar stack on mobile */
            .action-bar {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 0.75rem;
            }

            .action-bar .d-flex {
                flex-direction: column !important;
                width: 100%;
            }

            .action-bar .form-control,
            .action-bar .form-select {
                width: 100% !important;
                margin: 0 0 0.5rem 0 !important;
            }

            .action-bar .btn {
                width: 100%;
                margin: 0 0 0.5rem 0 !important;
            }

            .card-table {
                padding: 1rem;
                border-radius: 0.5rem;
            }

            .card-table .table-title { font-size: 1.1rem; }

            /* Make table scroll horizontally on mobile */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                font-size: 0.75rem;
                min-width: 800px;
            }

            .table th, .table td {
                padding: 0.4rem 0.3rem;
                white-space: nowrap;
            }

            /* Make modal full width on mobile */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-footer .btn {
                width: 100%;
                margin: 0;
            }

            /* Badge spacing */
            .badge-status {
                font-size: 0.7rem;
                padding: 0.3em 0.5em;
            }
        }

        /* Tablet Responsive Styles */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .container-fluid { padding: 1.5rem !important; }
            .header-banner { padding: 1.5rem; }

            .action-bar .d-flex {
                flex-wrap: wrap;
            }
        }

    /* Mobile performance tweaks */
    @media (max-width: 767.98px) {
      .card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section,
      .btn,
      .btn-action,
      .table-responsive,
      .menu-item a,
      .toggle-btn,
      .sidebar,
      .top-bar {
        transition: none !important;
      }

      .card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
      }

      .modal-content {
        font-size: 11px;
      }

      .modal-title,
      .modal-body,
      .modal-body .form-label,
      .modal-body .form-control,
      .modal-body .form-select,
      .modal-body .btn,
      .modal-footer .btn {
        font-size: 11px;
      }

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 0.5rem 0.75rem;
      }

      .modal-body .form-control,
      .modal-body .form-select {
        padding: 0.35rem 0.5rem;
      }

      .modal-footer {
        gap: 0.4rem;
      }
    }
.card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
      }

      .modal-title {
        font-size: 1rem;
      }

      .modal-body {
        font-size: 0.875rem;
      }

      .modal-body .form-label {
        font-size: 0.8125rem;
      }

      .modal-body .form-control,
      .modal-body .form-select {
        font-size: 0.875rem;
        padding: 0.5rem 0.65rem;
      }

      .modal-footer .btn {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
      }
    }
.card,
      .stat-card,
      .dashboard-card,
      .module-card,
      .header-section,
      .welcome-section {
        box-shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
      }
    }
.header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .badge,
      .table-responsive,
      .modal-content {
        box-shadow: none !important;
      }

      .header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .modal-content {
        border-radius: 8px !important;
      }

      .btn,
      .btn-action {
        box-shadow: none !important;
      }
    }
.header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .btn,
      .btn-action,
      .badge,
      .table-responsive,
      .modal-content {
        box-shadow: none !important;
      }

      .header-section,
      .welcome-section,
      .module-card,
      .card,
      .stat-card,
      .dashboard-card,
      .btn,
      .btn-action,
      .modal-content {
        border-radius: 8px !important;
      }
    }
</style>
</head>
<body>
    <div class="container-fluid p-4">
        <!-- Header Banner -->
        <div class="header-banner">
            <div class="icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <div>
                <h1 class="h3 mb-1">Inventory Management</h1>
                <p class="mb-0">Manage stock levels, track assets, and view valuation</p>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row" id="summary-cards">
            <!-- Cards will be dynamically inserted here -->
        </div>

        <!-- Action Bar -->
        <div class="d-flex justify-content-between align-items-center action-bar">
            <div class="d-flex">
                <input type="text" id="search-input" class="form-control me-2" placeholder="Search items...">
                <select id="filter-select" class="form-select me-2" style="width: 180px;">
                    <option value="all" selected>All Statuses</option>
                    <option value="In Stock">In Stock</option>
                    <option value="Low Stock">Low Stock</option>
                    <option value="Out of Stock">Out of Stock</option>
                </select>
            </div>
            <div>
                <button class="btn btn-gradient-primary me-2" onclick="addProduct()">
                    <i class="bi bi-plus-circle"></i> Add Product
                </button>
                <button class="btn btn-warning me-2" onclick="openReturnInventoryModal()">
                    <i class="bi bi-box-arrow-left"></i> Return Product
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Inventory Item List Table -->
        <div class="card-table">
            <h5 class="table-title">Inventory Items</h5>
            <div id="table-container" class="table-responsive">
                <!-- Table will be dynamically inserted here -->
            </div>
             <div id="loader" class="loader">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading inventory data...</p>
            </div>
        </div>
    </div>

    <!-- Return to Supplier Modal -->
    <div class="modal fade" id="returnInventoryModal" tabindex="-1" aria-labelledby="returnInventoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="returnInventoryModalLabel">
                        <i class="bi bi-arrow-counterclockwise"></i> Return to Supplier
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> This will <strong>decrease inventory</strong> and reduce supplier balance.
                    </div>

                    <form id="returnInventoryForm">
                        <input type="hidden" id="return-item-id" />

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Return Data</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshReturnModalData()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh lists
                            </button>
                        </div>

                        <div class="mb-3" id="return-item-dropdown-container">
                            <label for="return-item-select" class="form-label">Select Item to Return <span class="text-danger">*</span></label>
                            <select class="form-select" id="return-item-select" onchange="onReturnItemSelected()" required>
                                <option value="">Select item...</option>
                            </select>
                        </div>

                        <div class="mb-3" id="return-item-static-container" style="display: none;">
                            <label class="form-label fw-bold">Item Name</label>
                            <p id="return-item-name" class="form-control-plaintext text-muted"></p>
                        </div>

                        <div class="mb-3" id="return-stock-container" style="display: none;">
                            <label class="form-label fw-bold">Current Stock</label>
                            <p id="return-current-stock" class="form-control-plaintext text-muted"></p>
                        </div>

                        <div class="mb-3">
                            <label for="return-supplier" class="form-label">Return to Supplier <span class="text-danger">*</span></label>
                            <select class="form-select" id="return-supplier" required disabled>
                                <option value="">Select supplier...</option>
                            </select>
                            <div class="form-text text-muted">Supplier is locked to the selected item.</div>
                        </div>

                        <div class="mb-3">
                            <label for="return-quantity" class="form-label">Return Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="return-quantity" min="0.01" step="0.01" required>
                        </div>

                        <div class="mb-3">
                            <label for="return-reason" class="form-label">Reason <span class="text-danger">*</span></label>
                            <select class="form-select" id="return-reason" required>
                                <option value="">Select reason...</option>
                                <option value="Defective Goods">Defective Goods</option>
                                <option value="Wrong Item Received">Wrong Item Received</option>
                                <option value="Excess Stock">Excess Stock</option>
                                <option value="Expired/Damaged">Expired/Damaged</option>
                                <option value="Quality Issues">Quality Issues</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3" id="return-reason-other-container" style="display: none;">
                            <label for="return-reason-other" class="form-label">Please specify</label>
                            <input type="text" class="form-control" id="return-reason-other">
                        </div>

                        <div class="mb-3">
                            <label for="return-payment-method" class="form-label">Return Method <span class="text-danger">*</span></label>
                            <select class="form-select" id="return-payment-method" required>
                                <option value="Credit">Credit Note (Reduce Balance)</option>
                                <option value="Cash">Cash Refund</option>
                                <option value="Bank">Bank Transfer</option>
                                <option value="M-Pesa">M-Pesa</option>
                            </select>
                            <small class="form-text text-muted">Credit Note will reduce your payable to the supplier</small>
                        </div>

                        <div class="mb-3">
                            <label for="return-notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="return-notes" rows="2" placeholder="Optional notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitReturnInventory()">
                        <i class="bi bi-box-arrow-left"></i> Process Return to Supplier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allItems = []; // Store all items for client-side filtering

        document.addEventListener("DOMContentLoaded", function() {
            loadDashboardData();
            document.getElementById('search-input').addEventListener('input', applyFilters);
            document.getElementById('filter-select').addEventListener('change', applyFilters);
        });

        function loadDashboardData() {
            showLoader();
            google.script.run
                .withSuccessHandler(updateUI)
                .withFailureHandler(showError)
                .getInventoryDashboardData();
        }

        function refreshData() {
            loadDashboardData();
        }

        function updateUI(data) {
            console.log("Received data:", data);
            if(data.success) {
                allItems = data.inventory || [];
                updateSummaryCards(data.overview, allItems);
                applyFilters(); // Initial render
            } else {
                showError({message: data.message});
            }
            hideLoader();
        }

        function updateSummaryCards(overview, items) {
            // Fallback: compute total value from items if overview missing/zero
            const totalValueComputed = (items || []).reduce((sum, item) => {
                const qty = Number(item.Current_Qty || item.Stock_Qty || item.Stock_Level || 0);
                const cost = Number(item.Cost_Price || 0);
                const stockVal = Number(item.Stock_Value || 0);
                return sum + (stockVal || (qty * cost));
            }, 0);

            const totalValue = (overview && Number(overview.totalValue)) ? Number(overview.totalValue) : totalValueComputed;

            const container = document.getElementById('summary-cards');
            container.innerHTML =
                `<div class="col-12 col-sm-6 col-md-3">
                    <div class="summary-card bg-gradient-purple">
                        <div class="label">Total Items</div>
                        <div class="value">${overview.totalItems}</div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="summary-card bg-gradient-pink">
                        <div class="label">Low Stock</div>
                        <div class="value">${overview.lowStock}</div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="summary-card bg-gradient-cyan">
                        <div class="label">Out of Stock</div>
                        <div class="value">${overview.outOfStock}</div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="summary-card bg-gradient-orange">
                        <div class="label">Total Value</div>
                        <div class="value">${formatCurrency(totalValue)}</div>
                    </div>
                </div>
            `;
        }
        
        function applyFilters() {
            const searchValue = document.getElementById('search-input').value.toLowerCase();
            const filterValue = document.getElementById('filter-select').value;

            const filteredItems = allItems.filter(item => {
                const matchesSearch = item.Item_Name.toLowerCase().includes(searchValue) || item.Item_ID.toLowerCase().includes(searchValue);
                const matchesFilter = filterValue === 'all' || item.Status === filterValue;
                return matchesSearch && matchesFilter;
            });

            updateInventoryTable(filteredItems);
        }


        function updateInventoryTable(items) {
            const container = document.getElementById('table-container');
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No items match the current filters.</p>';
                return;
            }

            let tableHtml =
                `<table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Item ID</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th class="text-end">Stock</th>
                            <th class="text-end">Reorder</th>
                            <th>Unit</th>
                            <th class="text-end">Cost Price</th>
                            <th class="text-end">Selling Price</th>
                            <th class="text-end">Stock Value</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            items.forEach(item => {
                const statusBadge = getStatusBadge(item.Status);
                tableHtml +=
                    `<tr>
                        <td>${item.Item_ID || ''}</td>
                        <td>${item.Item_Name || ''}</td>
                        <td>${item.Category || ''}</td>
                        <td>${item.Supplier || ''}</td>
                        <td class="text-end">${item.Stock_Level}</td>
                        <td class="text-end">${item.Reorder_Level || 0}</td>
                        <td>${item.Unit || ''}</td>
                        <td class="text-end">${formatCurrency(item.Cost_Price || 0)}</td>
                        <td class="text-end">${formatCurrency(item.Selling_Price || 0)}</td>
                        <td class="text-end">${formatCurrency(item.Stock_Value || 0)}</td>
                        <td class="text-center">${statusBadge}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="returnInventory('${item.Item_ID}')" title="Return Inventory">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
        }
        
        function getStatusBadge(status) {
            switch(status) {
                case 'In Stock':
                    return 
`<span class="badge rounded-pill badge-status badge-in-stock">
${status}
</span>`
                case 'Low Stock':
                    return 
`<span class="badge rounded-pill badge-status badge-low-stock">
${status}
</span>`
                case 'Out of Stock':
                    return 
`<span class="badge rounded-pill badge-status badge-out-of-stock">
${status}
</span>`
                default:
                    return 
`<span class="badge rounded-pill bg-secondary">
${status}
</span>`
            }
        }

        function formatCurrency(value) {
            const num = Number(value) || 0;
            return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES', minimumFractionDigits: 0 }).format(num);
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('table-container').innerHTML = '';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showError(error) {
            hideLoader();
            const container = document.getElementById('table-container');
            container.innerHTML = `<p class="text-center text-danger">Error loading data: ${error.message}</p>`;
            console.error("Error loading data:", error);
        }

        function addProduct() {
            alert("Add new product functionality to be implemented.");
        }

        // Open return modal from button (no item pre-selected)
        function openReturnInventoryModal() {
            // Reset form
            document.getElementById('returnInventoryForm').reset();
            document.getElementById('return-item-id').value = '';
            document.getElementById('return-reason-other-container').style.display = 'none';

            // Show dropdown, hide static display
            document.getElementById('return-item-dropdown-container').style.display = 'block';
            document.getElementById('return-item-static-container').style.display = 'none';
            document.getElementById('return-stock-container').style.display = 'none';

            // Auto-refresh data on modal open
            refreshReturnModalData();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('returnInventoryModal'));
            modal.show();
        }

        // Handle item selection from dropdown
        function onReturnItemSelected() {
            const itemId = document.getElementById('return-item-select').value;
            if (!itemId) {
                document.getElementById('return-stock-container').style.display = 'none';
                document.getElementById('return-item-id').value = '';
                return;
            }

            const item = allItems.find(i => i.Item_ID === itemId);
            if (item) {
                document.getElementById('return-item-id').value = item.Item_ID;
                document.getElementById('return-current-stock').textContent = item.Stock_Level + ' ' + (item.Unit || 'units');
                document.getElementById('return-stock-container').style.display = 'block';
                preselectSupplierForItem(item);
            }
        }

        // Open return modal from row action button (item pre-selected)
        function returnInventory(itemId) {
            // Find the item in the current list
            const item = allItems.find(i => i.Item_ID === itemId);

            if (!item) {
                alert('Item not found');
                return;
            }

            // Reset form
            document.getElementById('returnInventoryForm').reset();
            document.getElementById('return-reason-other-container').style.display = 'none';

            // Hide dropdown, show static display
            document.getElementById('return-item-dropdown-container').style.display = 'none';
            document.getElementById('return-item-static-container').style.display = 'block';
            document.getElementById('return-stock-container').style.display = 'block';

            // Populate modal with item details
            document.getElementById('return-item-id').value = item.Item_ID;
            document.getElementById('return-item-name').textContent = item.Item_Name;
            document.getElementById('return-current-stock').textContent = item.Stock_Level + ' ' + (item.Unit || 'units');

            // Refresh suppliers (preselect item's supplier if available)
            loadSuppliersForReturn(item.Supplier || item.Supplier_ID);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('returnInventoryModal'));
            modal.show();
        }

        function populateReturnItemSelect() {
            const select = document.getElementById('return-item-select');
            if (!select) return;
            select.innerHTML = '<option value="">Select item...</option>';
            if (allItems && allItems.length > 0) {
                allItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.Item_ID;
                    option.textContent = `${item.Item_Name} (Stock: ${item.Stock_Level} ${item.Unit || 'units'})`;
                    select.appendChild(option);
                });
            }
        }

        function loadSuppliersForReturn(preselectId) {
            google.script.run
                .withSuccessHandler(function(suppliers) {
                    const select = document.getElementById('return-supplier');
                    select.innerHTML = '<option value="">Select supplier...</option>';
                    select.disabled = true; // lock supplier field

                    if (suppliers && suppliers.length > 0) {
                        const seen = {};
                        suppliers.forEach(supplier => {
                            const id = supplier.Supplier_ID || supplier.Supplier || '';
                            const name = (supplier.Supplier_Name || '').trim();
                            if (!id || seen[id]) return;
                            if (!name || name.toLowerCase() === 'supplier') return;
                            seen[id] = true;
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = name + ' (' + id + ')';
                            select.appendChild(option);
                        });
                    }

                    // Preselect supplier if provided
                    if (preselectId) {
                        select.value = preselectId;
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading suppliers:', error);
                })
                .getSuppliers();
        }

        function refreshReturnModalData() {
            // Reload inventory data and suppliers for the return modal
            loadDashboardData();
            populateReturnItemSelect();
            loadSuppliersForReturn();
        }

        function preselectSupplierForItem(item) {
            if (!item) return;
            const select = document.getElementById('return-supplier');
            if (!select) return;
            const preferred = item.Supplier || item.Supplier_ID || '';
            if (preferred) {
                select.value = preferred;
            }
            select.disabled = true; // lock supplier to item
        }

        // Show/hide "Other" reason input
        document.addEventListener('DOMContentLoaded', function() {
            const reasonSelect = document.getElementById('return-reason');
            if (reasonSelect) {
                reasonSelect.addEventListener('change', function() {
                    const otherContainer = document.getElementById('return-reason-other-container');
                    if (this.value === 'Other') {
                        otherContainer.style.display = 'block';
                    } else {
                        otherContainer.style.display = 'none';
                    }
                });
            }
        });

        function submitReturnInventory() {
            const itemId = document.getElementById('return-item-id').value;
            const supplierId = document.getElementById('return-supplier').value;
            const quantity = parseFloat(document.getElementById('return-quantity').value);
            let reason = document.getElementById('return-reason').value;
            const paymentMethod = document.getElementById('return-payment-method').value;
            const notes = document.getElementById('return-notes').value;

            // Validation
            if (!itemId || !supplierId || !quantity || !reason || !paymentMethod) {
                alert('Please fill in all required fields');
                return;
            }

            if (quantity <= 0) {
                alert('Quantity must be greater than 0');
                return;
            }

            // Check if quantity exceeds current stock
            const item = allItems.find(i => i.Item_ID === itemId);
            if (item && quantity > item.Stock_Level) {
                alert('Return quantity (' + quantity + ') exceeds current stock (' + item.Stock_Level + ')');
                return;
            }

            // If reason is "Other", use the custom text
            if (reason === 'Other') {
                const otherReason = document.getElementById('return-reason-other').value;
                if (!otherReason || otherReason.trim() === '') {
                    alert('Please specify the reason');
                    return;
                }
                reason = otherReason;
            }

            // Build full reason string with notes
            let fullReason = reason;
            if (notes) {
                fullReason += ' - ' + notes;
            }

            // Confirm action
            const supplierName = document.getElementById('return-supplier').selectedOptions[0].text;
            if (!confirm('Return ' + quantity + ' units to ' + supplierName + '?\n\nThis will:\n- Decrease inventory by ' + quantity + ' units\n- Reduce supplier balance\n- Create return transaction')) {
                return;
            }

            // Show loading state
            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            // Call backend to process supplier return
            google.script.run
                .withSuccessHandler(function(result) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;

                    if (result.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('returnInventoryModal'));
                        modal.hide();

                        // Show success message
                        alert('Supplier return processed successfully!\n\nReturn ID: ' + (result.returnId || 'N/A') + '\nReturned: ' + quantity + ' units\nTotal Cost: Ksh ' + (result.totalReturnCost || 0).toLocaleString() + '\n\nSupplier balance and inventory have been updated.');

                        // Refresh data
                        loadDashboardData();
                    } else {
                        alert('Error: ' + (result.message || 'Failed to process return'));
                    }
                })
                .withFailureHandler(function(error) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    alert('Error processing return: ' + error.message);
                })
                .processSupplierReturn(
                    supplierId,
                    [{Item_ID: itemId, Qty: quantity}],
                    fullReason,
                    paymentMethod,
                    'USER'
                );
        }

    </script>
</body>
</html>







