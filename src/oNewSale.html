<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>New Sale</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f6fa; padding: 20px; }
    .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .card { border: none; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
    /* Hidden area for receipt printing iframe */
    #printFrame { display: none; }

    /* Mobile Responsive Styles */
    @media (max-width: 767.98px) {
      body { padding: 10px; }
      .header-section { padding: 15px; border-radius: 10px; }
      .header-section h2 { font-size: 1.5rem; }
      .header-section p { font-size: 0.9rem; }
      .card { border-radius: 10px; }
      .card-body { padding: 15px; }

      /* Stack form inputs vertically on mobile */
      .row.mb-3 { margin-bottom: 1rem !important; }
      .form-label { margin-bottom: 0.3rem; font-size: 0.9rem; }
      .form-control, .form-select { font-size: 0.95rem; padding: 0.5rem; }

      /* Increase touch target size for buttons */
      .btn { min-height: 48px; font-size: 1rem; }
      .btn-lg { font-size: 1.1rem; }

      /* Improve button group wrapping */
      .d-flex.gap-2 { flex-wrap: wrap; }
      .d-flex.gap-2 .btn { flex: 1 1 auto; min-width: 140px; }

      /* Make input groups stack better */
      .input-group .btn { min-width: 48px; }

      /* Improve alert spacing */
      .alert { padding: 12px; font-size: 0.9rem; }
      .alert h4 { font-size: 1.2rem; }
    }

    /* Tablet Responsive Styles */
    @media (min-width: 768px) and (max-width: 991.98px) {
      body { padding: 15px; }
      .header-section { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="header-section">
    <h2><i class="bi bi-cart-plus"></i> New Transaction</h2>
    <p class="mb-0">Process sales and returns</p>
  </div>

  <div class="card">
    <div class="card-body">
      <form id="saleForm">
        <div class="row mb-3">
          <div class="col-12 col-sm-6 col-md-4 mb-3 mb-md-0">
            <label class="form-label fw-bold">Transaction Type</label>
            <select class="form-select" name="type" id="txnType" required onchange="toggleReturnMode()">
              <option value="Sale">Sale</option>
              <option value="Return">Return (Credit Note)</option>
            </select>
          </div>
          <div class="col-12 col-sm-6 col-md-4 mb-3 mb-md-0">
            <label class="form-label fw-bold">Date</label>
            <input type="date" class="form-control" name="saleDate" id="saleDate" required>
          </div>
          <div class="col-12 col-sm-6 col-md-4">
            <label class="form-label fw-bold">Processed By</label>
            <input type="text" class="form-control" id="displayUser" readonly>
          </div>
        </div>

        <hr>

      <div class="row mb-3">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
          <label class="form-label">Customer</label>
          <select class="form-select" name="customerId" id="customerSelect" onchange="fillCustomerDetails()">
            <option value="">Walk-in Customer</option>
          </select>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">KRA PIN</label>
          <input type="text" class="form-control" name="kraPin" id="kraPin" placeholder="A00..." >
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12 col-sm-6 col-md-4 mb-3 mb-md-0">
          <label class="form-label">Location</label>
          <input type="text" class="form-control" name="location" id="customerLocation" placeholder="e.g. Nairobi">
        </div>
        <div class="col-12 col-sm-6 col-md-4 mb-3 mb-md-0">
          <label class="form-label">Loyalty Points</label>
          <input type="number" class="form-control" id="loyaltyPoints" placeholder="0" readonly>
        </div>
        <div class="col-12 col-sm-6 col-md-4">
          <label class="form-label">Paybill / Ref</label>
          <input type="text" class="form-control" name="paybillNumber" id="paybillNumber" placeholder="Enter paybill/ref">
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12 col-md-5 mb-3 mb-md-0">
          <label class="form-label">Item/Product *</label>
          <div class="input-group">
            <select class="form-select" name="itemId" id="itemSelect" required>
              <option value="">Select Item</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="loadInventory()">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
        <div class="col-6 col-sm-4 col-md-2 mb-3 mb-md-0">
          <label class="form-label">Qty *</label>
          <input type="number" class="form-control" name="quantity" id="qtyInput" min="1" value="1" required>
        </div>
        <div class="col-6 col-sm-4 col-md-2 mb-3 mb-md-0">
          <label class="form-label">Unit Price</label>
          <input type="number" class="form-control" name="unitPrice" id="unitPrice" step="0.01">
        </div>
        <div class="col-12 col-sm-4 col-md-3 mb-3 mb-md-0">
          <label class="form-label">Payment Mode</label>
          <select class="form-select" name="paymentMode" id="paymentMode" required>
            <option value="Credit" selected>Credit/Debt</option>
            <option value="Cash">Cash</option>
            <option value="M-Pesa">M-Pesa</option>
            <option value="Equity Bank">Bank</option>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Delivery Charge</label>
          <input type="number" class="form-control" name="deliveryCharge" id="deliveryCharge" step="0.01" value="0">
        </div>
      </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
            <i class="bi bi-check-circle"></i> Complete Transaction
          </button>
        </div>
      </form>

      <div id="resultArea" class="mt-4 text-center" style="display: none;">
        <div class="alert alert-success">
          <h4 class="alert-heading"><i class="bi bi-check-circle-fill"></i> Success!</h4>
          <p id="successMessage"></p>
          <hr>
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-primary" onclick="resetForm()">
              <i class="bi bi-arrow-repeat"></i> New Transaction
            </button>
            <button class="btn btn-outline-secondary" onclick="google.script.host.close()">
              <i class="bi bi-x-circle"></i> Close
            </button>
          </div>
          <p class="mt-2 text-muted small">Tip: You can print receipts from Sales History</p>
        </div>
      </div>
      
      <div id="errorArea" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUser = sessionStorage.getItem('userName') || 'SYSTEM';
    let globalCustomers = []; // Store customers locally to pull details
    let lastTransactionId = null;

    document.addEventListener('DOMContentLoaded', function() {
      // Set Today's Date
      document.getElementById('saleDate').valueAsDate = new Date();
      document.getElementById('displayUser').value = currentUser;

      // Load Data
      loadCustomers();
      loadInventory();
    });

    function loadCustomers() {
      google.script.run.withSuccessHandler(function(data) {
        globalCustomers = data; // Save to global variable
        const select = document.getElementById('customerSelect');
        select.innerHTML = '<option value="">Walk-in Customer</option>';
        
        data.forEach(c => {
          const o = document.createElement('option');
          o.value = c.Customer_ID;
          o.textContent = c.Customer_Name || c.Name;
          select.appendChild(o);
        });
      }).getCustomers({status: 'Active'});
    }

    function loadInventory() {
      const select = document.getElementById('itemSelect');
      select.innerHTML = '<option value="">Loading...</option>';
      select.disabled = true;

      google.script.run
        .withSuccessHandler(function(data) {
                console.log('Received inventory data:', data);
                try {
                  select.innerHTML = '<option value="">Select Item</option>';
                  data.forEach(i => {
                    const stockQty = (i.Current_Qty !== undefined ? i.Current_Qty : i.Stock_Qty) || 0;
                    const o = document.createElement('option');
                    o.value = i.Item_ID;
                    o.textContent = `${i.Item_Name} - Ksh ${i.Selling_Price}`;
                    o.dataset.price = i.Selling_Price; // Store price in data attribute
                    if(stockQty <= 0) o.disabled = true; // Optional: disable out of stock
                    select.appendChild(o);
                  });
                  
                  // Auto-fill price on change
                  select.onchange = function() {
                     const price = this.options[this.selectedIndex].dataset.price;
                     if(price) document.getElementById('unitPrice').value = price;
                  };
                } catch (e) {
                  console.error('Error rendering inventory:', e);
                  showError('Error rendering inventory: ' + e.message);
                } finally {
                  select.disabled = false;
                }
              })        .withFailureHandler(function(error) {
          select.innerHTML = '<option value="">Error loading inventory</option>';
          select.disabled = true;
          showError(error.message);
        })
        .getInventory({});
    }

    // Auto-fill KRA PIN when customer is selected
    function fillCustomerDetails() {
      const custId = document.getElementById('customerSelect').value;
      const kraInput = document.getElementById('kraPin');
      const locationInput = document.getElementById('customerLocation');
      const pointsInput = document.getElementById('loyaltyPoints');
      
      if (custId) {
        const customer = globalCustomers.find(c => c.Customer_ID === custId);
        if (customer) {
          kraInput.value = customer.KRA_PIN || '';
          locationInput.value = customer.Location || '';
          pointsInput.value = customer.Loyalty_Points || 0;
        }
      } else {
        kraInput.value = '';
        locationInput.value = '';
        pointsInput.value = '';
      }
    }

    // Handle Return Mode (Visual cues)
    function toggleReturnMode() {
      const type = document.getElementById('txnType').value;
      const btn = document.getElementById('submitBtn');
      const qty = document.getElementById('qtyInput');
      
      if (type === 'Return') {
        btn.className = 'btn btn-danger btn-lg';
        btn.innerHTML = '<i class="bi bi-arrow-return-left"></i> Process Return';
      } else {
        btn.className = 'btn btn-primary btn-lg';
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Complete Sale';
      }
    }

    // Submit Handler
    document.getElementById('saleForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const btn = document.getElementById('submitBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
      
      document.getElementById('resultArea').style.display = 'none';
      document.getElementById('errorArea').style.display = 'none';

      const formData = Object.fromEntries(new FormData(e.target));
      const type = formData.type; // Sale, Quotation, Return

      // Build data object
      const saleData = {
        items: [{
          Item_ID: formData.itemId,
          Qty: parseFloat(formData.quantity),
          Unit_Price: parseFloat(formData.unitPrice) // Use edited price
        }],
        Customer_ID: formData.customerId || 'WALK-IN',
        Customer_Name: formData.customerId ? 
          document.getElementById('customerSelect').selectedOptions[0].textContent : 'Walk-in Customer',
        Payment_Mode: formData.paymentMode,
        User: currentUser,
        // New Fields
        KRA_PIN: formData.kraPin,
        Location: formData.location,
        Loyalty_Points: document.getElementById('loyaltyPoints').value,
        DateTime: formData.saleDate, // Backend will parse this
        Delivery_Charge: parseFloat(formData.deliveryCharge) || 0,
        Discount: 0
      };

      if (formData.paybillNumber) {
        saleData.Paybill_Number = formData.paybillNumber.trim();
      }

      // Determine backend function
      let backendFunc = 'createSale';
      // For Return, we might handle it via createSale but with logic, 
      // or calling 'processSaleReturn' if checking against old sale. 
      // For simplicity here, we'll treat Return as a Sale but handle via createSale logic
      // Note: A true return usually needs a reference to original sale ID. 
      // If this is a blind return (credit note), backend needs to handle negative stock logic.
      // Assuming iSales.gs createSale handles generic sales.

      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.innerHTML = originalText;

          if (result.success) {
            lastTransactionId = result.transactionId || result.purchaseId; // Store for printing
            
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('successMessage').textContent = 
              `${type} successfully processed! Ref: ${lastTransactionId}`;
            
            // Disable form to prevent double submit until reset
            document.getElementById('saleForm').style.opacity = '0.5';
            document.getElementById('saleForm').style.pointerEvents = 'none';
          } else {
            showError(result.message);
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          showError(error.message);
        })[backendFunc](saleData);
    });

    function resetForm() {
      document.getElementById('saleForm').reset();
      document.getElementById('saleForm').style.opacity = '1';
      document.getElementById('saleForm').style.pointerEvents = 'auto';
      document.getElementById('resultArea').style.display = 'none';
      document.getElementById('saleDate').valueAsDate = new Date();
      loadCustomers();
      loadInventory();
      lastTransactionId = null;
    }

    function showError(msg) {
      const el = document.getElementById('errorArea');
      el.textContent = 'Error: ' + msg;
      el.style.display = 'block';
    }
  </script>
</body>
</html>
