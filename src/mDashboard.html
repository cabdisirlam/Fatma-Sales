<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fatma Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      overflow-x: hidden;
      /* Prevent "pull-to-refresh" effect which feels like hanging */
      overscroll-behavior-y: none;
      /* Enable smooth scrolling on iOS */
      -webkit-overflow-scrolling: touch;
    }

    /* Quick Sale Specific Styles */
    .quick-sale-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .table-cart th {
      font-weight: 600;
      font-size: 0.85rem;
      color: #6c757d;
    }

    .table-cart td {
      vertical-align: middle;
      font-size: 0.9rem;
    }

    .total-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2ecc71;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%; /* Use 100% instead of 100vh for mobile browsers */
      width: 260px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 0 20px 0;
      transition: transform 0.3s ease; /* Use transform instead of left/width for performance */
      z-index: 1000;
      box-shadow: 4px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      /* Hardware acceleration to prevent lag */
      transform: translateX(0);
      -webkit-overflow-scrolling: touch; /* Smooth scroll on mobile */
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }

    .sidebar.collapsed {
      transform: translateX(-180px); /* Move off-screen slightly */
      width: 80px;
    }

    .sidebar-header {
      padding: 20px;
      text-align: center;
      color: white;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar-header h3 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed .sidebar-header h3,
    .sidebar.collapsed .sidebar-header p {
      display: none;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.8;
      margin: 0;
    }

    .menu-items {
      list-style: none;
      padding: 0;
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .menu-item {
      margin: 5px 15px;
    }

    .menu-item a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .menu-item a:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      transform: translateX(5px);
    }

    .menu-item a.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .menu-item i {
      font-size: 20px;
      min-width: 30px;
    }

    .menu-item span {
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .menu-label {
      margin: 15px 15px 5px;
      padding-left: 15px;
      font-size: 12px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.65);
      letter-spacing: 0.08em;
    }

    .sidebar.collapsed .menu-item span {
      display: none;
    }

    /* Submenu Styles */
    .submenu {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .submenu.active {
      max-height: 500px;
    }

    .submenu-item {
      margin: 0;
    }

    .submenu-item a {
      display: flex;
      align-items: center;
      padding: 10px 15px 10px 50px;
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 14px;
    }

    .submenu-item a:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      transform: translateX(5px);
    }

    .submenu-item a.active {
      background: rgba(255,255,255,0.15);
      color: white;
    }

    .submenu-item i {
      font-size: 16px;
      min-width: 20px;
    }

    .menu-item.has-submenu > a .bi-chevron-down {
      margin-left: auto;
      transition: transform 0.3s ease;
    }

    .menu-item.has-submenu.open > a .bi-chevron-down {
      transform: rotate(180deg);
    }

    .sidebar.collapsed .submenu {
      display: none;
    }

    .toggle-btn {
      position: absolute;
      top: 20px;
      right: -15px;
      width: 30px;
      height: 30px;
      background: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      transition: all 0.3s ease;
    }

    .toggle-btn:hover {
      transform: scale(1.1);
    }

    /* Main Content */
    .main-content {
      margin-left: 260px;
      padding: 20px;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    .main-content.expanded {
      margin-left: 80px;
    }

    /* Top Bar */
    .top-bar {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .top-bar .btn-back {
      margin-right: 15px;
    }

    .top-bar h2 {
      margin: 0;
      color: #2c3e50;
      font-size: 24px;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .user-details {
      text-align: right;
    }

    .user-details .name {
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }

    .user-details .role {
      font-size: 12px;
      color: #95a5a6;
    }

    /* Dashboard Content */
    .dashboard-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      min-height: 500px;
    }

    .welcome-section {
      text-align: center;
      padding: 40px 20px;
    }

    .welcome-icon {
      font-size: 80px;
      color: #667eea;
      margin-bottom: 20px;
    }

    .welcome-section h1 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 32px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px;
      border-radius: 12px;
      color: white;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .stat-card i {
      font-size: 40px;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .stat-card h3 {
      font-size: 32px;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .stat-card p {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    /* Content Sections */
    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* Navigation Buttons */
    .navigation-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nav-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-btn i {
      font-size: 18px;
    }

    .quick-add-card {
      border: 1px solid #e9ecef;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      padding: 16px;
      background: #fff;
    }

    .quick-add-card h6 {
      font-weight: 700;
      margin-bottom: 8px;
    }

    .quick-add-card .form-control,
    .quick-add-card .form-select {
      border-radius: 10px;
    }

    /* Hamburger Menu Button */
    .hamburger-btn {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1002;
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }

    .hamburger-btn:hover {
      transform: scale(1.05);
    }

    /* Mobile Menu Overlay */
    .menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .menu-overlay.active {
      display: block;
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hamburger-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar {
        transform: translateX(-100%); /* Completely hidden by default on mobile */
        width: 280px;
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .sidebar.mobile-open {
        transform: translateX(0); /* Slide in smoothly */
        box-shadow: 5px 0 15px rgba(0,0,0,0.2);
      }

      /* Prevent body scrolling when menu is open to stop "hanging" feel */
      body.menu-open {
        overflow: hidden;
      }

      .main-content {
        margin-left: 0 !important; /* Force full width on mobile */
        padding: 80px 15px 20px; /* Space for top bar */
      }

      .toggle-btn {
        display: none;
      }

      .top-bar {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }

      .top-bar h2 {
        font-size: 20px;
      }

      .user-profile {
        width: 100%;
        justify-content: space-between;
      }

      .navigation-controls {
        flex-direction: row;
        gap: 10px;
      }

      .nav-btn {
        flex: 1;
        justify-content: center;
        font-size: 14px;
        padding: 10px 15px;
      }

      .nav-btn span {
        display: none;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      /* Make supplier action buttons touch-friendly and stack vertically on mobile */
      .btn-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .btn-group .btn {
        width: 100%;
        min-height: 44px;
      }

      /* Hide less important table columns on mobile */
      .table td:nth-child(3),
      .table th:nth-child(3),
      .table td:nth-child(4),
      .table th:nth-child(4) {
        display: none;
      }

      .table {
        font-size: 14px;
      }

      .table th, .table td {
        padding: 8px 5px;
      }
    }

    @media (max-width: 480px) {
      .hamburger-btn {
        width: 40px;
        height: 40px;
        top: 15px;
        left: 15px;
      }

      .main-content {
        padding: 70px 10px 15px;
      }

      .top-bar h2 {
        font-size: 18px;
      }

      .nav-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    /* Custom styles for supplier action buttons and dropdowns */
    .btn-group .dropdown-menu {
      max-width: 90vw;
    }

    .dropdown-menu .dropdown-item {
      white-space: normal;
      padding: 10px 15px;
    }

    .dropdown-menu .dropdown-item:active {
      background-color: #667eea;
    }

    /* Supplier dropdown menu styling */
    .supplier-dropdown-menu {
      max-height: 300px;
      overflow-y: auto;
      min-width: 250px;
    }

    /* Compact summary cards */
    .card.border-0.bg-light {
      transition: transform 0.2s ease;
    }

    .card.border-0.bg-light:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Mobile-friendly button group in action bar */
    @media (max-width: 576px) {
      .d-flex.flex-wrap.gap-2 {
        justify-content: center;
      }

      .btn-group {
        flex: 1 1 auto;
        min-width: calc(50% - 4px);
      }

      .btn-group .btn-sm {
        font-size: 12px;
        padding: 6px 10px;
      }

      .btn-sm {
        font-size: 12px;
        padding: 6px 10px;
      }

      /* Make dropdown menus full width on very small screens */
      .dropdown-menu {
        position: fixed !important;
        left: 10px !important;
        right: 10px !important;
        top: auto !important;
        width: auto !important;
        max-width: none !important;
        transform: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Hamburger Menu Button -->
  <button class="hamburger-btn" onclick="toggleMobileMenu()" id="hamburgerBtn">
    <i class="bi bi-list"></i>
  </button>

  <!-- Menu Overlay -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeMobileMenu()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">
      <i class="bi bi-chevron-left" id="toggleIcon"></i>
    </button>

    <div class="sidebar-header">
      <h3>Fatma Sales</h3>
      <p>Management System</p>
    </div>

    <ul class="menu-items">
      <li class="menu-item">
        <a href="#" class="active" id="menu-dashboard" onclick="showSection('dashboard', event);">
          <i class="bi bi-speedometer2"></i>
          <span>Dashboard</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-sales" onclick="showSection('sales', event);">
          <i class="bi bi-cart-check"></i>
          <span>Sales</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-inventory" onclick="showSection('inventory', event);">
          <i class="bi bi-box-seam"></i>
          <span>Inventory</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-customers" onclick="showSection('customers', event);">
          <i class="bi bi-people"></i>
          <span>Customers</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-suppliers" onclick="showSection('suppliers-list', event);">
          <i class="bi bi-truck"></i>
          <span>Suppliers</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-quotations" onclick="showSection('quotations', event);">
          <i class="bi bi-file-text"></i>
          <span>Quotations</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-financials" onclick="showSection('financials', event);">
          <i class="bi bi-currency-dollar"></i>
          <span>Financials</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-reports" onclick="showSection('reports', event);">
          <i class="bi bi-bar-chart"></i>
          <span>Reports</span>
        </a>
      </li>

      <li class="menu-item" id="userManagementMenu">
        <a href="#" id="menu-users" onclick="showSection('users-list', event);">
          <i class="bi bi-people"></i>
          <span>Users</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="#" id="menu-settings" onclick="showSection('settings', event);">
          <i class="bi bi-gear"></i>
          <span>Settings</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="d-flex align-items-center">
        <button id="globalBackBtn" class="btn btn-outline-secondary btn-sm btn-back" onclick="goBack()" disabled>
          <i class="bi bi-arrow-left"></i> Back
        </button>
        <h2 id="pageTitle" class="mb-0">Dashboard</h2>
      </div>
      <div class="user-profile">
        <div class="user-details">
          <div class="name" id="userName">Loading...</div>
          <div class="role" id="userRole">Loading...</div>
        </div>
        <div class="user-avatar" id="userAvatar">
          <i class="bi bi-person"></i>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div class="content-section active" id="section-dashboard">
      <div class="dashboard-content">
        <div class="welcome-section">
          <i class="bi bi-check-circle-fill welcome-icon"></i>
          <h1>Welcome to Fatma Sales System!</h1>
          <p class="lead">Your complete business management solution</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <i class="bi bi-cart-check"></i>
            <h3 id="totalSales">0</h3>
            <p>Total Sales</p>
          </div>
          <div class="stat-card">
            <i class="bi bi-box-seam"></i>
            <h3 id="totalProducts">0</h3>
            <p>Products in Stock</p>
          </div>
          <div class="stat-card">
            <i class="bi bi-people"></i>
            <h3 id="totalCustomers">0</h3>
            <p>Active Customers</p>
          </div>
          <div class="stat-card">
            <i class="bi bi-currency-dollar"></i>
            <h3 id="totalRevenue">$0</h3>
            <p>Total Revenue</p>
          </div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Sales Main Section -->
    <div class="content-section" id="section-sales">
      <div class="dashboard-content">
        <h3><i class="bi bi-cart-check"></i> Sales Overview</h3>
        <p class="text-muted">Manage all sales operations and monitor revenue performance.</p>
        <hr>
        <div class="row g-3 mt-3">
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Total Revenue</h5>
                <h3 class="mb-1" id="salesTotalRevenue">--</h3>
                <p class="text-muted small">Across all completed sales</p>
                <div class="d-grid">
                  <button class="btn btn-primary" onclick="showSection('sales-reports')">View Reports</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Total Sales</h5>
                <h3 class="mb-1" id="salesCount">--</h3>
                <p class="text-muted small">Unique sale transactions</p>
                <div class="d-grid">
                  <button class="btn btn-outline-primary" onclick="showSection('sales-history')">Sales History</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Credit Sales</h5>
                <h3 class="mb-1" id="salesCreditCount">--</h3>
                <p class="text-muted small">Sales marked as credit</p>
                <div class="d-grid">
                  <button class="btn btn-outline-warning" onclick="showSection('sales-returns')">View Returns</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Avg. Order Value</h5>
                <h3 class="mb-1" id="salesAverageOrder">--</h3>
                <p class="text-muted small">Based on completed sales</p>
                <div class="d-grid">
                  <button class="btn btn-outline-success" onclick="startNewSale(event)">Create Sale</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="alert alert-info mt-3 mb-0" id="salesOverviewAlert" style="display: none;"></div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-sales-new">
      <div class="dashboard-content">
        <h3><i class="bi bi-cart-plus"></i> Quick Sale / Quotation</h3>
        <p class="text-muted">Process a sale or create a quotation</p>
        
        <div class="row">
          <div class="col-md-8">
            <div class="card shadow-sm">
              <div class="card-body">
                <form id="dashboardSaleForm">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Customer</label>
                      <select class="form-select" id="dashSaleCustomer">
                        <option value="WALK-IN">Walk-in Customer</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Payment Mode</label>
                      <select class="form-select" id="dashSalePayment">
                        <option value="Cash">Cash</option>
                        <option value="M-Pesa">M-Pesa</option>
                        <option value="Equity Bank">Equity Bank</option>
                        <option value="Credit">Credit (Debt)</option>
                      </select>
                    </div>
                  </div>

                  <hr>

                  <div class="row align-items-end mb-3">
                    <div class="col-md-5">
                      <label class="form-label fw-bold">Product</label>
                      <select class="form-select" id="dashSaleProduct" onchange="updateDashProductDetails()">
                        <option value="">-- Choose Item --</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Qty</label>
                      <input type="number" class="form-control" id="dashSaleQty" value="1" min="1">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Price (Editable)</label>
                      <input type="number" class="form-control" id="dashSalePrice" min="0" step="0.01">
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-primary w-100" onclick="addDashCartItem()">
                        <i class="bi bi-plus-lg"></i> Add
                      </button>
                    </div>
                  </div>

                  <div class="table-responsive border rounded mb-3" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-sm table-striped mb-0">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th>Item</th>
                          <th>Qty</th>
                          <th>Price</th>
                          <th>Total</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="dashCartBody">
                        <tr><td colspan="5" class="text-center text-muted">Cart is empty</td></tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                      <h4 class="mb-0 text-success">Total: <span id="dashCartTotal">Ksh 0.00</span></h4>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-secondary" onclick="clearDashCart()">Clear</button>
                      
                      <button type="button" class="btn btn-warning text-dark" onclick="submitDashTransaction('Quotation')">
                        <i class="bi bi-file-text"></i> Save Quotation
                      </button>
                      
                      <button type="button" class="btn btn-success px-4" onclick="submitDashTransaction('Sale')">
                        <i class="bi bi-check-circle"></i> Complete Sale
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card bg-light border-0">
              <div class="card-body">
                <h6>Product Details</h6>
                <div id="dashProductInfo" class="text-muted small">Select a product to see details.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()"><i class="bi bi-chevron-left"></i> Previous</button>
        <button class="nav-btn" onclick="navigateToNext()">Next <i class="bi bi-chevron-right"></i></button>
      </div>
    </div>

    <div class="content-section" id="section-sales-history">
      <div class="dashboard-content">
        <h3 class="d-flex justify-content-between align-items-center">
          <span><i class="bi bi-clock-history"></i> Sales History</span>
          <small class="text-muted">Most recent transactions</small>
        </h3>
        <div class="table-responsive mt-3">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Transaction</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Payment</th>
                <th class="text-end">Total</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="salesHistoryBody">
              <tr><td colspan="7" class="text-center text-muted py-4">Loading sales history...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-sales-returns">
      <div class="dashboard-content">
        <h3 class="d-flex justify-content-between align-items-center">
          <span><i class="bi bi-arrow-return-left"></i> Sales Returns</span>
          <small class="text-muted">Items marked as returned</small>
        </h3>
        <div class="table-responsive mt-3">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Transaction</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Item</th>
                <th>Qty</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody id="salesReturnsBody">
              <tr><td colspan="6" class="text-center text-muted py-4">Loading return data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-sales-reports">
      <div class="dashboard-content">
        <h3><i class="bi bi-file-earmark-bar-graph"></i> Sales Reports</h3>
        <p class="text-muted">High level metrics to understand your performance.</p>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <p class="text-muted mb-1">Total Revenue</p>
                <h4 id="reportTotalRevenue">--</h4>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <p class="text-muted mb-1">Total Sales</p>
                <h4 id="reportTotalSales">--</h4>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <p class="text-muted mb-1">Credit Sales</p>
                <h4 id="reportCreditSales">--</h4>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <p class="text-muted mb-1">Avg Order Value</p>
                <h4 id="reportAverageOrder">--</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <h5 class="card-title mb-3">Last 30 Days Revenue</h5>
            <p class="display-6" id="report30DayRevenue">--</p>
            <p class="text-muted mb-0">Shows the total revenue generated in the last 30 days.</p>
          </div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Inventory Section -->
    <div class="content-section" id="section-inventory">
      <div class="dashboard-content">
        <h3><i class="bi bi-box-seam"></i> Inventory Management</h3>
        <p class="text-muted">Track and manage your product inventory</p>
        <hr>
        <p>Inventory module content will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Customers Section -->
    <div class="content-section" id="section-customers">
      <div class="dashboard-content">
        <h3><i class="bi bi-people"></i> Customer Management</h3>
        <p class="text-muted">Manage your customer database</p>
        <hr>
        <p>Customer module content will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Quotations Section -->
    <div class="content-section" id="section-quotations">
      <div class="dashboard-content">
        <h3><i class="bi bi-file-text"></i> Quotations</h3>
        <p class="text-muted">Create and manage price quotations</p>
        <hr>
        <p>Quotations module content will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Financials Section -->
    <div class="content-section" id="section-financials">
      <div class="dashboard-content">
        <h3><i class="bi bi-currency-dollar"></i> Financial Management</h3>
        <p class="text-muted">Track revenue, expenses, and financial reports</p>
        <hr>
        <p>Financial module content will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Reports Section -->
    <div class="content-section" id="section-reports">
      <div class="dashboard-content">
        <h3><i class="bi bi-bar-chart"></i> Reports & Analytics</h3>
        <p class="text-muted">View detailed reports and analytics</p>
        <hr>
        <p>Reports module content will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Suppliers Sections -->
    <div class="content-section" id="section-suppliers-list">
      <div class="dashboard-content">
        <h3><i class="bi bi-truck"></i> Suppliers List</h3>
        <p class="text-muted">View and manage all suppliers</p>
        <hr>
        <p>Suppliers list and management will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-suppliers-add">
      <div class="dashboard-content">
        <h3><i class="bi bi-plus-circle"></i> Add New Supplier</h3>
        <p class="text-muted">Register a new supplier</p>
        <hr>
        <p>Add supplier form will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-suppliers-orders">
      <div class="dashboard-content">
        <h3><i class="bi bi-cart-plus"></i> Purchase Orders</h3>
        <p class="text-muted">Manage purchase orders from suppliers</p>
        <hr>
        <p>Purchase orders management will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-suppliers-payments">
      <div class="dashboard-content">
        <h3><i class="bi bi-credit-card"></i> Supplier Payments</h3>
        <p class="text-muted">Track and manage payments to suppliers</p>
        <hr>
        <p>Supplier payments tracking will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- User Management Sections -->
    <div class="content-section" id="section-users-list">
      <div class="dashboard-content">
        <h3><i class="bi bi-people"></i> Users List</h3>
        <p class="text-muted">View and manage all system users</p>
        <hr>

        <!-- Alert Container -->
        <div id="usersAlertContainer"></div>

        <!-- Add User Button -->
        <div class="mb-3">
          <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="bi bi-person-plus"></i> Add New User
          </button>
        </div>

        <!-- Users Table -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-users-add">
      <div class="dashboard-content">
        <h3><i class="bi bi-person-plus"></i> Add New User</h3>
        <p class="text-muted">Create a new user account</p>
        <hr>
        <p>Add user form will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-users-roles">
      <div class="dashboard-content">
        <h3><i class="bi bi-shield-check"></i> User Roles</h3>
        <p class="text-muted">Manage user roles and access levels</p>
        <hr>
        <p>User roles management will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="content-section" id="section-users-permissions">
      <div class="dashboard-content">
        <h3><i class="bi bi-key"></i> User Permissions</h3>
        <p class="text-muted">Configure user permissions and access control</p>
        <hr>
        <p>User permissions configuration will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="content-section" id="section-settings">
      <div class="dashboard-content">
        <h3><i class="bi bi-gear"></i> System Settings</h3>
        <p class="text-muted">Configure your system preferences</p>
        <hr>
        <p>Settings module content will be loaded here...</p>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-btn" onclick="navigateToPrevious()">
          <i class="bi bi-chevron-left"></i>
          <span>Previous</span>
        </button>
        <button class="nav-btn" onclick="navigateToNext()">
          <span>Next</span>
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </main>

  <div class="modal fade" id="returnSaleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="bi bi-arrow-return-left"></i> Return Items</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="returnSaleId">
          <div class="alert alert-warning small">
            <i class="bi bi-exclamation-triangle"></i> Returned items will be added back to inventory.
          </div>
          <div id="returnItemsContainer">
            </div>
          <div class="mt-3">
            <label class="form-label">Reason for Return</label>
            <input type="text" id="returnReason" class="form-control" placeholder="e.g. Damaged, Wrong Item">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" onclick="submitReturn()">Confirm Return</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supplier Payment Modal -->
  <div class="modal fade" id="supplierPaymentModal" tabindex="-1" aria-labelledby="supplierPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="supplierPaymentModalLabel">
            <i class="bi bi-cash-coin"></i> Record Supplier Payment
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="paymentSupplierId">

          <div class="alert alert-info mb-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <strong>Supplier:</strong> <span id="paymentSupplierName"></span>
              </div>
              <div>
                <strong>Balance:</strong> <span id="paymentCurrentBalance" class="text-danger"></span>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="paymentAmount" class="form-label">Payment Amount (Ksh) *</label>
            <input type="number" class="form-control" id="paymentAmount" min="0" step="0.01" required>
            <div class="form-text">Enter the amount you're paying to this supplier</div>
          </div>

          <div class="mb-3">
            <label for="paymentMethod" class="form-label">Payment Method *</label>
            <select class="form-select" id="paymentMethod" required>
              <option value="Cash">Cash</option>
              <option value="M-Pesa">M-Pesa</option>
              <option value="Equity Bank">Equity Bank</option>
            </select>
            <div class="form-text">Select the account to pay from</div>
          </div>

          <div class="mb-3">
            <label for="paymentReference" class="form-label">Reference/Receipt No</label>
            <input type="text" class="form-control" id="paymentReference" placeholder="e.g., TXN123456">
            <div class="form-text">Optional: M-Pesa code, check number, or receipt reference</div>
          </div>

          <div class="mb-3">
            <label for="paymentNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="paymentNotes" rows="2" placeholder="Optional payment notes"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
          <button type="button" class="btn btn-success" id="submitPaymentBtn" onclick="dashboardSubmitPayment()">
            <i class="bi bi-check-circle"></i> Submit Payment
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supplier Edit Modal -->
  <div class="modal fade" id="supplierEditModal" tabindex="-1" aria-labelledby="supplierEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="supplierEditModalLabel">
            <i class="bi bi-pencil-square"></i> Edit Supplier
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editSupplierId">

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editSupplierName" class="form-label">Supplier Name *</label>
              <input type="text" class="form-control" id="editSupplierName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editContactPerson" class="form-label">Contact Person</label>
              <input type="text" class="form-control" id="editContactPerson">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editPhone" class="form-label">Phone *</label>
              <input type="tel" class="form-control" id="editPhone" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail">
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="editAddress" class="form-label">Address</label>
              <textarea class="form-control" id="editAddress" rows="2"></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="editPaymentTerms" class="form-label">Payment Terms</label>
              <input type="text" class="form-control" id="editPaymentTerms" placeholder="e.g., Net 30">
            </div>
            <div class="col-md-4 mb-3">
              <label for="editStatus" class="form-label">Status</label>
              <select class="form-select" id="editStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Current Balance</label>
              <input type="text" class="form-control" id="editBalance" readonly disabled>
              <div class="form-text">Balance cannot be edited directly</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
          <button type="button" class="btn btn-warning" id="submitEditBtn" onclick="dashboardSubmitEdit()">
            <i class="bi bi-check-circle"></i> Update Supplier
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supplier Statement Modal -->
  <div class="modal fade" id="supplierStatementModal" tabindex="-1" aria-labelledby="supplierStatementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="supplierStatementModalLabel">
            <i class="bi bi-file-text"></i> Supplier Statement
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="statementLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading statement...</p>
          </div>

          <div id="statementContent" style="display: none;">
            <!-- Supplier Info -->
            <div class="card mb-3">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h5 id="statementSupplierName"></h5>
                    <p class="mb-1"><strong>Supplier ID:</strong> <span id="statementSupplierId"></span></p>
                    <p class="mb-1"><strong>Contact:</strong> <span id="statementContact"></span></p>
                    <p class="mb-0"><strong>Phone:</strong> <span id="statementPhone"></span></p>
                  </div>
                  <div class="col-md-6 text-end">
                    <div class="stat-card mb-0">
                      <div class="stat-label">Current Balance</div>
                      <div class="stat-value text-danger" id="statementBalance">Ksh 0.00</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Statement Summary -->
            <div class="row mb-3">
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-label">Opening Balance</div>
                  <div class="stat-value" id="statementOpening">Ksh 0.00</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-label">Total Purchases</div>
                  <div class="stat-value text-danger" id="statementDebits">Ksh 0.00</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-label">Total Payments</div>
                  <div class="stat-value text-success" id="statementCredits">Ksh 0.00</div>
                </div>
              </div>
            </div>

            <!-- Transactions Table -->
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Reference</th>
                    <th class="text-end">Purchases</th>
                    <th class="text-end">Payments</th>
                    <th class="text-end">Balance</th>
                  </tr>
                </thead>
                <tbody id="statementTransactions">
                  <!-- Transactions will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Close
          </button>
          <button type="button" class="btn btn-primary" onclick="window.print()">
            <i class="bi bi-printer"></i> Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="dashboardAddUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="dashboardAddUserForm" onsubmit="handleDashboardAddUser(event)">
            <div class="mb-3">
              <label class="form-label">Username *</label>
              <input type="text" class="form-control" id="newUsername" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" id="newEmail" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone</label>
                <input type="text" class="form-control" id="newPhone">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">PIN (4 Digits) *</label>
                <input type="password" class="form-control" id="newPin" maxlength="4" pattern="[0-9]{4}" required>
                <div class="form-text">Must be 4 numbers.</div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Role *</label>
                <select class="form-select" id="newRole" required>
                  <option value="Admin">Admin</option>
                  <option value="Manager">Manager</option>
                  <option value="Sales">Sales</option>
                  <option value="Cashier">Cashier</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="newStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="btnSaveUser">Save User</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="dashboardCustomerEditModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">Edit Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCustomerId">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="editCustomerName">
          </div>
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input type="text" class="form-control" id="editCustomerPhone">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="editCustomerEmail">
          </div>
          <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" class="form-control" id="editCustomerLocation">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-warning" id="btnSubmitCustEdit" onclick="dashboardSubmitCustomerEdit()">Update</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="dashboardCustomerPayModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Receive Payment</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="recvCustomerId">
          <div class="alert alert-light text-center border">
             <h5 id="recvCustomerName"></h5>
             <span id="recvCustomerBal" class="fw-bold text-danger fs-5"></span>
             <br><small>Current Balance</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Amount (Ksh)</label>
            <input type="number" class="form-control form-control-lg" id="recvAmount">
          </div>
          <div class="mb-3">
            <label class="form-label">Account</label>
            <select class="form-select" id="recvAccount">
               <option value="Cash">Cash</option>
               <option value="M-Pesa">M-Pesa</option>
               <option value="Equity Bank">Equity Bank</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="recvRef" placeholder="Receipt / Ref No">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" id="btnSubmitCustPay" onclick="dashboardSubmitCustomerPay()">Confirm Payment</button>
        </div>
      </div>
    </div>
  </div>

    <script>
    // --- GLOBAL VARIABLES ---
    let dashCart = [];
    let dashProducts = [];
    let dashCustomers = [];

    // --- INITIALIZATION ---
    window.onload = function() {
      // Load initial dashboard stats
      loadDashboardData();
    };

    function showSection(id) {
      document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
      document.getElementById('section-' + id).classList.add('active');
      document.getElementById('pageTitle').textContent = id.replace('-', ' ').toUpperCase();
      
      // Load specific section data
      if(id === 'sales-new') loadNewSaleInDashboard();
      if(id === 'sales-history') loadSalesHistory();
      if(id === 'dashboard') loadDashboardData();
    }

    function loadDashboardData() {
      google.script.run.withSuccessHandler(data => {
        document.getElementById('dashTotalSales').innerText = data.saleCount || 0;
        document.getElementById('dashTotalRevenue').innerText = 'Ksh ' + (data.totalRevenue || 0).toLocaleString();
      }).getSalesOverview();
    }

    // --- QUICK SALE / QUOTATION LOGIC ---

    function loadNewSaleInDashboard() {
      clearDashCart();
      
      // 1. Load Customers
      google.script.run.withSuccessHandler(function(customers) {
        dashCustomers = customers || [];
        const sel = document.getElementById('dashSaleCustomer');
        
        // Reset Dropdown
        sel.innerHTML = '<option value="WALK-IN">Walk-in Customer</option>';
        
        if (dashCustomers.length > 0) {
          // Sort alphabetically by Name
          dashCustomers.sort((a, b) => (a.Customer_Name || '').localeCompare(b.Customer_Name || ''));
          
          dashCustomers.forEach(c => {
            // STRICTLY use Customer_Name and ID
            const name = c.Customer_Name || 'Unknown Name';
            const phone = c.Phone ? ` (${c.Phone})` : '';
            
            // Create Option
            const opt = new Option(name + phone, c.Customer_ID);
            sel.add(opt);
          });
        }
      }).getCustomers();

      // 2. Load Inventory
      google.script.run.withSuccessHandler(function(items) {
        dashProducts = items || [];
        const sel = document.getElementById('dashSaleProduct');
        sel.innerHTML = '<option value="">-- Choose Item --</option>';
        if (dashProducts.length > 0) {
          dashProducts.forEach(i => {
            const stock = i.Current_Qty !== undefined ? i.Current_Qty : i.Stock_Qty;
            // Only show items with stock
            if (stock > 0) {
               sel.add(new Option(`${i.Item_Name} (Stock: ${stock})`, i.Item_ID));
            }
          });
        }
      }).getInventory();
    }

    function updateDashProductDetails() {
      const id = document.getElementById('dashSaleProduct').value;
      const product = dashProducts.find(p => p.Item_ID === id);
      
      if (product) {
        document.getElementById('dashSalePrice').value = product.Selling_Price;
        const stock = product.Current_Qty !== undefined ? product.Current_Qty : product.Stock_Qty;
        document.getElementById('dashProductInfo').innerHTML = `
           <div class="mb-2"><strong>Item:</strong> ${product.Item_Name}</div>
           <div class="mb-2"><strong>Category:</strong> ${product.Category || '-'}</div>
           <div class="mb-2 text-primary"><strong>Standard Price:</strong> Ksh ${product.Selling_Price}</div>
           <div class="mb-2 ${stock < 10 ? 'text-danger' : 'text-success'}"><strong>Current Stock:</strong> ${stock}</div>
        `;
      } else {
        document.getElementById('dashSalePrice').value = '';
        document.getElementById('dashProductInfo').innerText = 'Select a product to see details.';
      }
    }

    function addDashCartItem() {
      const id = document.getElementById('dashSaleProduct').value;
      const qty = parseFloat(document.getElementById('dashSaleQty').value);
      const price = parseFloat(document.getElementById('dashSalePrice').value);
      
      const product = dashProducts.find(p => p.Item_ID === id);

      if (!product || !id) return alert("Please select a product.");
      if (isNaN(qty) || qty <= 0) return alert("Please enter a valid quantity.");
      if (isNaN(price) || price < 0) return alert("Please enter a valid price.");

      // Check stock
      const stock = product.Current_Qty !== undefined ? product.Current_Qty : product.Stock_Qty;
      if (qty > stock) {
        return alert(`Insufficient stock. Only ${stock} available.`);
      }

      dashCart.push({
        Item_ID: id,
        Item_Name: product.Item_Name,
        Qty: qty,
        Unit_Price: price,
        Total: qty * price
      });

      renderDashCart();
      
      // Reset inputs
      document.getElementById('dashSaleProduct').value = '';
      document.getElementById('dashSaleQty').value = 1;
      document.getElementById('dashSalePrice').value = '';
      document.getElementById('dashProductInfo').innerText = 'Select a product to see details.';
    }

    function renderDashCart() {
      const tbody = document.getElementById('dashCartBody');
      tbody.innerHTML = '';
      let total = 0;

      dashCart.forEach((item, index) => {
        total += item.Total;
        tbody.innerHTML += `
          <tr>
            <td>${item.Item_Name}</td>
            <td>${item.Qty}</td>
            <td>${formatCurrency(item.Unit_Price)}</td>
            <td>${formatCurrency(item.Total)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-danger" onclick="removeDashItem(${index})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });

      document.getElementById('dashCartTotal').innerText = formatCurrency(total);
      
      if (dashCart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Cart is empty</td></tr>';
      }
    }

    function removeDashItem(index) {
      dashCart.splice(index, 1);
      renderDashCart();
    }

    function clearDashCart() {
      dashCart = [];
      renderDashCart();
      document.getElementById('dashSaleCustomer').value = 'WALK-IN';
      document.getElementById('dashSalePayment').value = 'Cash';
    }

    // --- TRANSACTION SUBMISSION (SALE OR QUOTATION) ---
    function submitDashTransaction(type) {
      if (dashCart.length === 0) return alert("Cart is empty. Add items first.");

      const customerId = document.getElementById('dashSaleCustomer').value;
      const paymentMode = document.getElementById('dashSalePayment').value;
      const custSelect = document.getElementById('dashSaleCustomer');
      const customerName = custSelect.options[custSelect.selectedIndex].text;

      // Validation
      if (type === 'Sale' && customerId === 'WALK-IN' && paymentMode === 'Credit') {
        return alert("Error: Walk-in customers cannot buy on Credit.");
      }

      // Calculate Validity Date safely for Quotations
      let validUntilString = null;
      if (type === 'Quotation') {
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 14); // Add 14 days
        validUntilString = futureDate.toISOString(); // FIXED: Convert Date to String
      }

      const transactionData = {
        Customer_ID: customerId,
        Customer_Name: customerName,
        Payment_Mode: paymentMode,
        items: dashCart,
        User: sessionStorage.getItem('userName') || 'SYSTEM',
        Delivery_Charge: 0,
        Discount: 0,
        Valid_Until: validUntilString // Now passing a String, not a Date object
      };

      const backendFunc = type === 'Quotation' ? 'createQuotation' : 'createSale';
      
      // Disable buttons and show loading
      const btns = document.querySelectorAll('button');
      btns.forEach(b => b.disabled = true);
      const submitBtn = event.target; // Get the specific button clicked
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

      google.script.run
        .withSuccessHandler(function(res) {
           btns.forEach(b => b.disabled = false);
           submitBtn.innerHTML = originalText;
           
           if (res.success) {
             clearDashCart();
             loadNewSaleInDashboard(); // Refresh stock
             
             // Open Receipt/Quotation
             openReceiptModal(res.transactionId, type);
           } else {
             alert("Error: " + res.message);
           }
        })
        .withFailureHandler(function(e) {
           btns.forEach(b => b.disabled = false);
           submitBtn.innerHTML = originalText;
           alert("System Error: " + e.message);
        })
        [backendFunc](transactionData);
    }

    // --- PRINTING & RECEIPT LOGIC ---
    function openReceiptModal(transactionId, type) {
      const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
      modal.show();
      
      const title = type === 'Quotation' ? 'Quotation' : 'Receipt';
      document.querySelector('#receiptModal .modal-title').innerHTML = `<i class="bi bi-printer"></i> Print ${title}`;
      
      document.getElementById('receiptContent').innerHTML = 
        '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Generating...</p></div>';

      // Decide which backend function to call
      const backendFunc = type === 'Quotation' ? 'generateQuotationHTML' : 'generateReceiptHTML';

      google.script.run
        .withSuccessHandler(function(html) {
          const iframe = document.createElement('iframe');
          iframe.id = 'printFrame';
          iframe.style.width = '100%';
          iframe.style.height = '450px';
          iframe.style.border = 'none';
          
          document.getElementById('receiptContent').innerHTML = '';
          document.getElementById('receiptContent').appendChild(iframe);
          
          const doc = iframe.contentWindow.document;
          doc.open();
          doc.write(html);
          doc.close();
        })
        .withFailureHandler(function(e) {
          document.getElementById('receiptContent').innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
        })
        [backendFunc](transactionId);
    }

    function printReceiptFrame() {
      const iframe = document.getElementById('printFrame');
      if (iframe) {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
      }
    }

    // --- SALES HISTORY & RETURNS ---
    function loadSalesHistory() {
      const tbody = document.getElementById('salesHistoryBody');
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><span class="spinner-border text-primary"></span> Loading...</td></tr>';

      google.script.run.withSuccessHandler(function(rows) {
          if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No sales found</td></tr>';
            return;
          }

          tbody.innerHTML = rows.map(function(row) {
            const isReturned = row.Status === 'Returned';
            const statusBadge = isReturned
              ? '<span class="badge bg-warning text-dark">Returned</span>'
              : '<span class="badge bg-success">Completed</span>';
            
            // Print Button (Always visible)
            let actions = `<button class="btn btn-sm btn-outline-secondary me-1" onclick="openReceiptModal('${row.Transaction_ID}', 'Sale')" title="Print"><i class="bi bi-printer"></i></button>`;
            
            // Return Button (Only if not already returned)
            if (!isReturned) {
               actions += `<button class="btn btn-sm btn-outline-danger" onclick="initiateReturn('${row.Transaction_ID}')" title="Return"><i class="bi bi-arrow-return-left"></i></button>`;
            }

            return `
              <tr>
                <td>${row.Transaction_ID}</td>
                <td>${new Date(row.DateTime).toLocaleDateString()}</td>
                <td>${row.Customer_Name || 'Walk-in'}</td>
                <td>${row.Payment_Mode || '-'}</td>
                <td class="text-end">${formatCurrency(row.Grand_Total)}</td>
                <td>${statusBadge}</td>
                <td>${actions}</td>
              </tr>
            `;
          }).join('');
        }).getSalesHistory(20);
    }

    function initiateReturn(saleId) {
      google.script.run.withSuccessHandler(function(sale) {
          document.getElementById('returnSaleId').value = sale.Transaction_ID;
          const container = document.getElementById('returnItemsContainer');

          let html = '<table class="table table-sm"><thead><tr><th>Item</th><th>Sold</th><th>Return Qty</th></tr></thead><tbody>';
          (sale.items || []).forEach(function(item) {
            html += `
              <tr>
                <td>${item.Item_Name}</td>
                <td>${item.Qty}</td>
                <td>
                  <input type="number" class="form-control form-control-sm return-qty" 
                         data-id="${item.Item_ID}" 
                         max="${item.Qty}" min="0" value="0">
                </td>
              </tr>`;
          });
          html += '</tbody></table>';
          container.innerHTML = html;

          new bootstrap.Modal(document.getElementById('returnSaleModal')).show();
        }).getSaleById(saleId);
    }

    function submitReturn() {
      const saleId = document.getElementById('returnSaleId').value;
      const reason = document.getElementById('returnReason').value;
      const inputs = document.querySelectorAll('.return-qty');
      const itemsToReturn = [];

      inputs.forEach(function(input) {
        const qty = parseFloat(input.value);
        if (qty > 0) {
          itemsToReturn.push({ Item_ID: input.getAttribute('data-id'), Qty: qty });
        }
      });

      if (itemsToReturn.length === 0) return alert('Please select at least one item to return.');
      if (!reason) return alert('Please enter a reason for the return.');

      // Backend call to process return and update inventory
      google.script.run
        .withSuccessHandler(function(res) {
          alert(res.message); // "Return processed successfully"
          bootstrap.Modal.getInstance(document.getElementById('returnSaleModal')).hide();
          loadSalesHistory(); // Refresh history table
        })
        .processSaleReturn(saleId, itemsToReturn, reason, sessionStorage.getItem('userName'));
    }

    function formatCurrency(num) {
      return 'Ksh ' + parseFloat(num).toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
  </script>

</body>
</html>
